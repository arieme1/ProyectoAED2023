---
title: "Informe"
author: "Mar Riveiro Cabado"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introducción

# Instalación y carga de librerías necesarias

```{r}
rm(list=ls())
library(pacman)
packages = c("knitr", "ggplot2","tidyr","dplyr","readr","GGally", "mice", "robustbase", "leaflet")
pacman::p_load(char=packages)
```

# Conjunto de datos


```{r}
estaciones<-read_delim("./data/Maestro_Climatologico_2022.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE,show_col_types = FALSE)

agregar_separador <- function(numero, posicion) {
  # Convertir el número a cadena de caracteres
  numero_str <- as.character(numero)
  
  # Insertar el separador en la posición deseada
  numero_formateado <- paste0(
    substr(numero_str, 1, posicion),
    ".",
    substr(numero_str,posicion + 1, nchar(numero_str))
  )
  
  # Devolver el resultado como número
  return(as.numeric(numero_formateado))
}

estaciones$LATITUD <- agregar_separador(estaciones$LATITUD, 2)
estaciones$LONGITUD <- agregar_separador(estaciones$LONGITUD, 1)

estaciones$LONGITUD<-estaciones$LONGITUD*(-1)


estaciones$LONGITUD[estaciones$PROVINCIA %in% c("TARRAGONA", "BARCELONA")] <- -estaciones$LONGITUD[estaciones$PROVINCIA %in% c("TARRAGONA", "BARCELONA")]

estaciones$LONGITUD[estaciones$PROVINCIA %in% c("LAS PALMAS", "SANTA CRUZ DE TENERIFE")] <- 10*estaciones$LONGITUD[estaciones$PROVINCIA %in% c("LAS PALMAS", "SANTA CRUZ DE TENERIFE")]
```


```{r}
carpeta_base<-"./data/Variables/"

años<-2016:2022
lista_dataframes <- list()

for (año in años){
  
  ruta_carpeta<-file.path(carpeta_base, as.character(año))
  archivos_climaticos <- list.files(ruta_carpeta,pattern = ".*.csv")
  
  df_año<-data.frame(Indicativo = character(0), 
                     Meses = character(0), Valores= numeric(0))

  for (archivo in archivos_climaticos) {
    
    ruta_completa_archivo<-file.path(ruta_carpeta,archivo)
    variable <-read_delim(ruta_completa_archivo, delim = ";",
                          escape_double = FALSE, trim_ws=TRUE,
                          show_col_types=FALSE)
    prefijo <- substr(archivo, 1, nchar(archivo) - 9)
  
    df_variable <- variable %>%
        pivot_longer(col = -c(Indicativo), names_to = "Meses", 
                     values_to = prefijo) 
    
      if (archivo == archivos_climaticos[1]) {
          
        df_año <- df_variable
        
       } else {
         
        df_año <- left_join(df_año,df_variable,
                            by=join_by("Indicativo","Meses"))
       }
    
  }
    lista_dataframes[[as.character(año)]] <- df_año
    assign(paste0("df_", año), df_año, envir = .GlobalEnv)
    carpeta<-"./data/"
    nombre_archivo <- file.path(carpeta, paste0("dataset_",año,".csv"))
    write.csv(df_año, nombre_archivo, row.names = FALSE)
}

```




Variables:

  * HR -> humedad relativa mensual/anual (%)
  * INSO -> Media mensual/anual de la insolación diaria (horas)
  * P_MES -> Precipitación total mensual/anual (mm)
  * TM_MAX -> Temperatura media mensual/anual de las máximas (°C)
  * TM_MES -> Temperatura media mensual/anual (°C)
  * TM_MIN -> Temperatura media mensual/anual de las mínimas (°C)

# Exploración Inicial de los datos

## Comprobación de datos faltantes e imputación

```{r}
faltan_2016<- colMeans(is.na(df_2016)) * 100

data_filtered <- df_2016 %>% filter(Meses != "anual") #filtro el dataset quitando los años

imputed_data_filtered <- mice(data_filtered, m = 5) #hago la imputación de datos con mice

imputed_data_2016 <- complete(imputed_data_filtered, action = 1) #introduzco los datos

filtered_rows <- df_2016 %>% filter(Meses == "anual") #tomo el dataset que solo contiene los "anual"

#ahora obtengo los valores anuales por indicativo para cada variable
columnas <- c("HR", "INSO","TM_MAX","TM_MES","TM_MIN","W_MED")
columnas2 <- c("P_MES")
columnas_F <- c("HR", "INSO","P_MES","TM_MAX","TM_MES","TM_MIN","W_MED")

#dataframe con los promedios anuales por indicativo
result <- imputed_data_2016 %>%
  group_by(Indicativo) %>%
  summarise(across(all_of(columnas), mean))

#dataframe con la suma anual de precipitaciones
result2 <-imputed_data_2016 %>%
  group_by(Indicativo)%>%
  summarise(across(all_of("P_MES"), sum))

#los uno y los ordeno conforme al original
df_2016_anual <- mutate(result, result2)
df_2016_anual <-df_2016_anual[,c("Indicativo","HR", "INSO","P_MES","TM_MAX","TM_MES","TM_MIN","W_MED")]

d_prueba<- imputed_data_2016 %>% group_by(Meses)

```



```{r}
#ANUAL
estaciones <- estaciones %>%
  rename(Indicativo = INDICATIVO)
Indicativos_maestro <- unique(unlist(estaciones[,"Indicativo"]))
años<-2016:2022
columnas <- c("HR", "INSO","TM_MAX","TM_MES","TM_MIN","W_MED")
columnas2 <- c("P_MES")
dataframes_anuales <- list()
dataframes_mensuales <- list()
i <- 2016

for (df in lista_dataframes){
  Indicativos_df <- unique(unlist(df[,"Indicativo"]))
  I_comunes <- intersect(Indicativos_df, Indicativos_maestro)
  
  Localizame <- estaciones[,c("Indicativo","PROVINCIA", "LONGITUD", "LATITUD", "MUNICIPIO")]
  Localizame <- Localizame%>%subset(Indicativo %in% I_comunes)

  data_filtered <- df %>% filter(Meses != "anual")%>%subset(Indicativo %in% I_comunes) 

  imputed_data_filtered <- mice(data_filtered, m = 15) 
  imputed_data <- complete(imputed_data_filtered, action = 1) 
#hago la imputación de datos con mice e introduzco los datos

  filtered_rows <- df %>% filter(Meses == "anual")%>%subset(Indicativo %in% I_comunes) 

  result <- imputed_data %>%group_by(Indicativo) %>%summarise(across(all_of(columnas), mean))

  result2 <-imputed_data %>%group_by(Indicativo)%>%summarise(across(all_of("P_MES"), sum))

  df_anual <- mutate(result, result2)
  df_anual<-df_anual[,c("Indicativo","HR","INSO","P_MES","TM_MAX","TM_MES","TM_MIN","W_MED")]
  df_anual <- merge(df_anual, Localizame, by = "Indicativo")
  nombre_df_a <- paste0("df_anual", i)
  dataframes_anuales[[nombre_df_a]] <- df_anual
  
  
  df_mensual <- merge(imputed_data, Localizame, by = "Indicativo")
  nombre_df_m <-paste0("df_mensual", i)
  dataframes_mensuales[[nombre_df_m]] <- df_mensual
  i<-i+1
}
list2env(dataframes_mensuales, envir = .GlobalEnv)
list2env(dataframes_anuales, envir = .GlobalEnv)
```


## Visualización de los datos

```{r}
grupo <- imputed_data_2016 %>% group_by(Indicativo, Meses)

ggplot(grupo, aes(x = grupo$Meses, y = grupo$P_MES , fill = grupo$Indicativo)) +
  geom_bar(stat = "identity") +
  labs(x = "Mes", y = "Promedio de Valor", title = "Precipitaciones") + theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  theme_minimal()
```


## Comprobación de outliers

```{r}
library(ggplot2)
library(gganimate)
factorizar_meses <- function(df) {
  df$Meses <- factor(df$Meses, levels = c("enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"))
  return(df)
}

#Para el calculo de outliers se hizo uso de la regla MADM
outliers <- which(abs(grupo$W_MED- median(grupo$W_MED)) > 3*mad(grupo$W_MED))


nombres_dataframes <- c("df_mensual2016", "df_mensual2017", "df_mensual2018", "df_mensual2019", "df_mensual2020", "df_mensual2021", "df_mensual2022")

# Bucle for para factorizar la columna Meses en cada dataframe
for (nombre_df in nombres_dataframes) {
  # Obtener el dataframe por nombre
  df <- get(nombre_df)
  
  # Factorizar la columna Meses utilizando la función
  df_factorizado <- factorizar_meses(df)
  
  # Asignar el dataframe factorizado de vuelta al entorno global
  assign(nombre_df, df_factorizado)
}

grafico_outliers_pmes <- df_mensual2017 %>%
  ggplot(aes(x = PROVINCIA , y = P_MES)) +
  geom_boxplot() +
  labs(title = "Precipitaciones Medias por Provincia Outliers", x = "Provincia", y = "Precipitaciones") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

grafico_outliers_pmes

grafico_outliers_inso <- df_mensual2017 %>%
  ggplot(aes(x = PROVINCIA , y = INSO)) +
  geom_boxplot() +
  labs(title = "Insolacion por Provincia Outliers", x = "Provincia", y = "Insolacion") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
grafico_outliers_inso

grafico_outliers_hr <- df_mensual2017 %>%
  ggplot(aes(x = PROVINCIA , y = HR)) +
  geom_boxplot() +
  labs(title = "Humedad Relativa por Provincia Outliers", x = "Provincia", y = "Humedad Relativa") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
grafico_outliers_hr

grafico_outliers_tmes <- df_mensual2017 %>%
  ggplot(aes(x = PROVINCIA , y = TM_MES)) +
  geom_boxplot() +
  labs(title = "Temperatura Medias por Provincia Outliers", x = "Provincia", y = "Temperatura") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
grafico_outliers_tmes

grafico_outliers_tmax <- df_mensual2017 %>%
  ggplot(aes(x = PROVINCIA , y = TM_MAX)) +
  geom_boxplot() +
  labs(title = "Tempereatura Maxima por Provincia Outliers", x = "Provincia", y = "Tempertura Maxima") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
grafico_outliers_tmax

grafico_outliers_tmin <- df_mensual2017 %>%
  ggplot(aes(x = PROVINCIA , y = TM_MIN)) +
  geom_boxplot() +
  labs(title = "Temperatura Minima por Provincia Outliers", x = "Provincia", y = "Temperatura Minima") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
grafico_outliers_tmin

grafico_outliers_wmed <- df_mensual2017 %>%
  ggplot(aes(x = PROVINCIA , y = W_MED)) +
  geom_boxplot() +
  labs(title = "Viento Medio por Provincia Outliers", x = "Provincia", y = "Viento") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
grafico_outliers_wmed

lista_outliers <- list()

for (df_names in names(dataframes_mensuales)) {
  df <- dataframes_mensuales[[df_names]]
  outliers_df <- list()
  
  for (i in names(df)) {
    outliers <- NULL
    
    if (is.numeric(df[[i]])) {
      if (any(!is.finite(df[[i]]))) {
        cat("Variable:", i, " contiene valores no finitos (NA, Inf, -Inf)\n")
      } else {
        iqr <- IQR(df[[i]], na.rm = TRUE)
        inferior <- quantile(df[[i]], c(0.25), na.rm = TRUE)
        superior <- quantile(df[[i]], c(0.75), na.rm = TRUE)
        
        cat("Variable:", i, "\t IQR:", iqr, "\t Inferior:", inferior, "\t Superior:", superior, "\n")
        
        outliers <- df[df[[i]] < (inferior - 1.5 * iqr) | df[[i]] > (superior + 1.5 * iqr), ]
        outliers_df[[i]] <- outliers
        
        cat("Variable:", i, "\t Outliers:", nrow(outliers), "\n")
      }
    }
  }
  
  lista_outliers[[df_names]] <- outliers_df
}
```

De cara al estudio de los outliers, primero se decidio hacer un estudio visual mediante el graficado de distintos graficos de caja, para cada una de las variables, para el año 2017.

Tras la representación se definio una funcion para calcular todos los outliers de 2017, dicha funcion se define haciendo uso del metodo de boxplot, el cual consiste en definir los cuantiles y los valores que se salgan tanto por el primer cuantil como por el tercer cuantil son los que la funcion determina como outliers. Una vez detectados los meses y las provincias de los outliers se investigo si dichos outliers tenian sentido, tras una extensa busqueda se llego a la conclusion de que los outliers obtenidos se debian a tormentas, olas de calor y mas eventos climatologicos.

Una vez detectados los outliers se amplio el rango de la funcion para todos los años.

Tras la identificacion de en que consistian los outliers se decidio dejarlos ya que pueden ser de interes para un estudio.



## Estadísticos

```{r}
estadisticos_indicativo <- list()
estadisticos_meses <- list()

años <- 2016:2022

for (i in seq_along(dataframes_mensuales)) {
  df_año <- dataframes_mensuales[[i]]
  df_año$Indicativo <- factor(df_año$Meses, levels = c("enero", "febrero", "marzo", 
                                                       "abril", "mayo", "junio", "julio", "agosto" ,
                                                       "septiembre", "octubre", "noviembre",
                                                       "diciembre"))
  df_año$Meses <- factor(df_año$Meses)

  esta_por_indicativo <- df_año %>%
    group_by(Indicativo) %>%
    summarise(across(where(is.numeric), 
                     list(mean = ~mean(., na.rm = TRUE), 
                          sd = ~sd(., na.rm = TRUE), 
                          median = ~median(., na.rm = TRUE),
                          iqr = ~IQR(., na.rm = TRUE),
                          mad = ~mad(., constant = 1.4826))))

  nombre_ind <- paste0("esta_por_indicativo_", años[i])
  estadisticos_indicativo[[nombre_ind]] <- esta_por_indicativo

  esta_por_mes <- df_año %>%
    group_by(Meses) %>%
    summarise(across(where(is.numeric), 
                     list(mean = ~mean(., na.rm = TRUE), 
                          sd = ~sd(., na.rm = TRUE), 
                          median = ~median(., na.rm = TRUE),
                          iqr = ~IQR(., na.rm = TRUE),
                          mad = ~mad(., constant = 1.4826))))

  nombre_mes <- paste0("esta_por_mes_", años[i])
  estadisticos_meses[[nombre_mes]] <- esta_por_mes
}


```


# Análisis Univariado
Tras el analisis de los outliers y los estadisticos de nuestro dataset, se empieza a hacer un estudio univariado de las distintas variables de interes.

```{r}
#COMPLETO 2016:2022
library(ggthemes)

lluvias_2022 <- df_mensual2022 %>% group_by(Meses)%>% summarise(prom_HR = mean(HR))%>%mutate(Año = 2022)
lluvias_2021 <- df_mensual2021 %>% group_by(Meses)%>% summarise(prom_HR = mean(HR))%>%mutate(Año = 2021)
lluvias_2020 <- df_mensual2020 %>% group_by(Meses)%>% summarise(prom_HR = mean(HR))%>%mutate(Año = 2020)
lluvias_2019 <- df_mensual2019 %>% group_by(Meses)%>% summarise(prom_HR = mean(HR))%>%mutate(Año = 2019)
lluvias_2018 <- df_mensual2018 %>% group_by(Meses)%>% summarise(prom_HR = mean(HR))%>%mutate(Año = 2018)
lluvias_2017 <- df_mensual2017 %>% group_by(Meses)%>% summarise(prom_HR = mean(HR))%>%mutate(Año = 2017)


lluvias <- bind_rows(lluvias_2022,lluvias_2021, lluvias_2020,lluvias_2019)
lluvias$Meses <- factor(lluvias$Meses, levels = c("enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto" ,"septiembre", "octubre", "noviembre", "diciembre"))

# Crea el gráfico de línea

precipitaciones = ggplot(lluvias, aes(x = Meses, y = prom_HR, group = Año))+geom_line(aes(linetype =  factor(Año),color=factor(Año)),size = 1.3, alpha = 0.7) + labs(title = "Promedio mensual de precipitaciones", subtitle = "España 2022", x = "Meses", y = "Precipitaciones (mm)")+ theme_fivethirtyeight() + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + theme(legend.title=element_blank())
precipitaciones

```
En esta primera grafica se representa la variacion de las temperaturas a lo largo de los meses para los años 2019,2020,2021,2022. Se puede observar una clara tendencia de disminucion entre los meses mas calientes, mientras que cuando se acerca el otoño y el invierno las precipitaciones aumentan.
Otra cosa destacable es que a medida que pasan los años se puede observar que las precipitaciones aumentan de manera general.
```{r}
tmax_2022 <- df_mensual2022 %>% group_by(Meses)%>%summarise(prom_tmax = mean(TM_MAX))%>%mutate(Año = 2022)
tmax_2021 <- df_mensual2021 %>% group_by(Meses)%>%summarise(prom_tmax = mean(TM_MAX))%>%mutate(Año = 2021)
tmax_2020 <- df_mensual2020 %>% group_by(Meses)%>%summarise(prom_tmax = mean(TM_MAX))%>%mutate(Año = 2020)
tmax_2019 <- df_mensual2019 %>% group_by(Meses)%>%summarise(prom_tmax = mean(TM_MAX))%>%mutate(Año = 2019)
tmax_2018 <- df_mensual2018 %>% group_by(Meses)%>%summarise(prom_tmax = mean(TM_MAX))%>%mutate(Año = 2018)
tmax_2017 <- df_mensual2017 %>% group_by(Meses)%>%summarise(prom_tmax = mean(TM_MAX))%>%mutate(Año = 2017)

tmaximas <- bind_rows(tmax_2022, tmax_2021, tmax_2020,tmax_2019)
tmaximas$Meses <- factor(tmaximas$Meses, levels = c("enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto" ,"septiembre", "octubre", "noviembre", "diciembre"))

maximas = ggplot(tmaximas, aes(x = Meses, y = prom_tmax, group = Año))+geom_line(aes(linetype =  factor(Año),color=factor(Año)),size = 1, alpha = 0.7) + labs(title = "Temperaturas máximas", subtitle = "España 2022", x = "Meses", y = "Temperatura (ºC)")+ theme_fivethirtyeight() + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + theme(legend.title=element_blank()) + scale_color_brewer(palette = "PuOr")
maximas
```

```{r}
tmed_2022 <- df_mensual2022 %>% group_by(Meses)%>%summarise(prom_tmed = mean(TM_MES))%>%mutate(Año = 2022)
tmed_2021 <- df_mensual2021 %>% group_by(Meses)%>%summarise(prom_tmed = mean(TM_MES))%>%mutate(Año = 2021)
tmed_2020 <- df_mensual2020 %>% group_by(Meses)%>%summarise(prom_tmed = mean(TM_MES))%>%mutate(Año = 2020)
tmed_2019 <- df_mensual2019 %>% group_by(Meses)%>%summarise(prom_tmed = mean(TM_MES))%>%mutate(Año = 2019)
tmed_2018 <- df_mensual2018 %>% group_by(Meses)%>%summarise(prom_tmed = mean(TM_MES))%>%mutate(Año = 2018)
tmed_2017 <- df_mensual2017 %>% group_by(Meses)%>%summarise(prom_tmed = mean(TM_MES))%>%mutate(Año = 2017)

tmed <- bind_rows(tmed_2022, tmed_2021, tmed_2020,tmed_2019)
tmed$Meses <- factor(tmed$Meses, levels = c("enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto" ,"septiembre", "octubre", "noviembre", "diciembre"))

medias = ggplot(tmed, aes(x = Meses, y = prom_tmed, group = Año))+geom_line(aes(linetype =  factor(Año),color=factor(Año)),size = 1, alpha = 0.7) + labs(title = "Temperaturas medias", subtitle = "España 2022", x = "Meses", y = "Temperatura (ºC)")+ theme_fivethirtyeight() + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + theme(legend.title=element_blank()) + scale_color_brewer(palette = "Set2")
medias
```
En las dos graficas siguientes se puede observar tanto la temperatura maxima como la temperatura media a lo largo de los años en toda España, se observa que los meses mas calidos son de septiembre a agosto mientras que en el resto de meses la temperatura disminuye por debajo de los 15 grados. 

# Análisis Bivariado

```{r}
correlacion_pearson <- list()
correlacion_spearman <- list()
covarianzas <- list()
años <- 2016:2022

for (i in seq_along(dataframes_mensuales)) {
  df_año <- dataframes_mensuales[[i]]
  df_año$Indicativo <- factor(df_año$Meses, levels = c("enero", "febrero", "marzo", 
                                                       "abril", "mayo", "junio", "julio", "agosto" ,
                                                       "septiembre", "octubre", "noviembre",
                                                       "diciembre"))
  df_año$Meses <- factor(df_año$Meses)
  
  variables_año <- df_año[, c("HR", "INSO", "P_MES", "TM_MAX", "TM_MES", "TM_MIN", "W_MED")]
  
  correlacion_pearson_ <- cor(variables_año, method = "pearson", use = "complete.obs")
  nombre_corp <- paste0("correlacion_pearson_", años[i])
  correlacion_pearson[[nombre_corp]] <- correlacion_pearson_
  
  correlacion_spearman_ <- cor(variables_año, method = "spearman", use = "complete.obs")
  nombre_cors <- paste0("correlacion_spearman_", años[i])
  correlacion_spearman[[nombre_cors]] <- correlacion_spearman_

  covarianzas_ <- cov(variables_año, use = "complete.obs")
  nombres_cov <- paste0("covarianzas_", años[i])
  covarianzas[[nombres_cov]] <- covarianzas_
}

```


```{r}
# Configurar el diseño de la ventana gráfica
par(mfrow = c(3, 3))
library(corrplot)
for (año in años) {
  corrplot(correlacion_pearson[[paste0("correlacion_pearson_", año)]], 
           method = "color", type = "lower", diag = FALSE)
}

# Restaurar la configuración original de la ventana gráfica
par(mfrow = c(1, 1))

```


Vemos que, en general, estes gráficos que representan la correlación entre las variables son prácticamente iguales para cada año, por lo tanto, vamos a centrarnos en los datos del año $2022$, para realizar un análisis más concreto y preciso.


```{r}
corrplot(correlacion_pearson[["correlacion_pearson_2022"]], type = "lower", diag = FALSE)
```

Por entender un poco mejor lo que nos quiere decir esta gráfica, cuan más grande es el círculo situado en las correspondientes casillas de las variables, más fuerte es la relación entre ellas (en azul si dicha correlación es lineal positiva y en rojo si es negativa). Cuanto más se reduce el tamaño del círculo, esto indica que la correlación entre las variables disminuye.

Por lo tanto, las conclusiones que extraemos de analizar este gráfico son las siguientes:

* La velocidad del viento, *W_MED*, no está prácticamente correlacionada con el resto de variables, por lo que la apartarmos de momento de nuestro estudio.

* Las variables *T_MAX*, *T_MIN* y *T_MES*, que recordamos que hacían referencia a:

  * TM_MAX -> Temperatura media mensual/anual de las máximas (°C)
  * TM_MES -> Temperatura media mensual/anual (°C)
  * TM_MIN -> Temperatura media mensual/anual de las mínimas (°C)
  
  Claramente estas variables están fuertemente correlacionadas, lo cual es lógico y natural, ya que estamos hablando de lo mismo, temperaturas, pero dando un dato distinto cada una de ellas.
  
* Por lo demás, las relaciones más destacables (teniendo en cuenta el objetivo de nuestro estudio) que extraemos del gráfico son las siguientes:

  * insolacion y precipitaciones medias
  * insolacion y humedad
  * temperatura maxima y precipitacion mes
  * temperatura maxima y humedad
  * temperatura maxima e insolacion

Además de centrarnos en el gráfico, echemos un ojo a la matriz de correlaciones, tanto de Pearson como la de Spearman y la matriz de covarianzas.


* Coeficiente de Correlación de Pearson: Mide la fuerza y dirección de una relación lineal.

```{r}
correlacion_pearson[["correlacion_pearson_2022"]]
```

* Coeficiente de Correlación de Spearman: Evalúa la relación monótona entre dos variables.

```{r}
correlacion_spearman[["correlacion_spearman_2022"]]
```

* Matriz de covarianzas.

```{r}
covarianzas[["covarianzas_2022"]]
```

Iniciamos el analisis de la correlacion para el año $2022$:


```{r}
d_22<-dataframes_mensuales[["df_mensual2022"]]
HR<-dataframes_mensuales[["df_mensual2022"]]%>%
  select(Indicativo,Meses,HR)
P_MES<-dataframes_mensuales[["df_mensual2022"]]%>%
  select(Indicativo,Meses,P_MES)
INSO<-dataframes_mensuales[["df_mensual2022"]]%>%
  select(Indicativo,Meses,INSO)
T_MAX<-dataframes_mensuales[["df_mensual2022"]]%>%
  select(Indicativo,Meses,TM_MAX)
T_MES<-dataframes_mensuales[["df_mensual2022"]]%>%
  select(Indicativo,Meses,TM_MES)
```

```{r}
correlation_matrix <- cor(d_22[, c("HR", "P_MES", "INSO", "TM_MAX")])
heatmap(correlation_matrix)

```


  * Insolacion y Precipitaciones medias
  
```{r}
library(ggplot2)
ggplot(d_22, aes(x=INSO, y=P_MES)) +
  geom_point() +
  geom_smooth(method="lm", se=FALSE, color="blue") +
  labs(title="Scatter Plot con Línea de Regresión", x="Insolación", y="Precipitación Media")

```


```{r}
boxplot(d_22$INSO ~ cut(d_22$P_MES, breaks=3), 
        main="Boxplot de Insolación por Niveles de Precipitación", 
        xlab="Niveles de Precipitación", ylab="Insolación")

```


  * Insolacion y Humedad
  
```{r}
ggplot(d_22, aes(x=HR, fill=INSO)) +
  geom_bar(position="stack") +
  labs(title="Gráfico de Barras Apiladas", x="Humedad", y="Frecuencia", fill="Insolación")

```
  
  * Temperatura Maxima y Precipitacion mes
  
```{r}
ggplot(d_22, aes(x=TM_MAX, y=P_MES)) +
  geom_density_2d() +
  labs(title="Gráfico de Contorno o Densidad", x="Temperaturas", y="Precipitación Media")

```

  
  * Temperatura Maxima y Humedad
  
```{r}
ggplot(d_22, aes(x=HR, y=TM_MAX, fill=HR)) +
  geom_violin() +
  labs(title="Diagrama de Violín", x="Humedad", y="Insolación", fill="Humedad")

```

  
  * Temperatura Maxima e Insolacion
  
```{r}
ggplot(d_22, aes(x=TM_MAX, y=INSO, size=INSO)) +
  geom_point(alpha=0.7,col="lightblue",fill="black") +
  labs(title="Gráfico de Burbujas", x="Temperaturas", y="Insolación", size="Temperaturas")
```

  
```{r}
pares<-dataframes_mensuales[["df_mensual2022"]]%>%
  select(HR,INSO,P_MES,TM_MAX,TM_MES,TM_MIN,W_MED)
ggpairs(pares)
#,ggplot2::aes(col="black",fill = "lightblue"
```



# Visualización de los datos

### Mapa interactivo

```{r}
mapa_espana <- leaflet() %>%
  addTiles() %>%
  setView(lng = -4, lat = 40, zoom = 6) %>% addCircles(lng = df_anual2022$LONGITUD, lat = df_anual2022$LATITUD, data = df_anual2022,radius = 5, popup = paste0(
  df_anual2022$MUNICIPIO,"<hr>",
  "T. Med (ºC):", round(df_anual2022$TM_MES,1),"<br>",
  "T. Max (ºC):", round(df_anual2022$TM_MAX,1),"<br>",
  "Precipitaciones (mm):", round(df_anual2022$P_MES),"<br>",
  "Insolación (horas):", round(df_anual2022$INSO,1)))

# Muestra el mapa
mapa_espana


```


#Graficas animadas para cada mes
```{r}
p <- ggplot(df_mensual2017, aes(x = PROVINCIA, y = P_MES, group = Meses)) +
  geom_line() +
  labs(title = 'Precipitaciones por Provincia', x = 'Provincia', y = 'Precipitaciones') +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


# Añade la animación por año
p_animada <- p + transition_states(Meses, transition_length = 2, state_length = 1)
anim_save("p_animada.gif", animation = p_animada, renderer = gifski_renderer())

browseURL("p_animada.gif")

tmes <- ggplot(df_mensual2017, aes(x = PROVINCIA, y = TM_MES, group = Meses)) +
  geom_line() +
  labs(title = 'Temperatura Media por Provincia', x = 'Provincia', y = 'Temperatura Media') +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

#transition_reveal(P_MES)
# Añade la animación por año
TMes_animada <- tmes + transition_states(Meses, transition_length = 2, state_length = 1)
anim_save("TMes_animada.gif", animation = TMes_animada, renderer = gifski_renderer())

browseURL("TMes_animada.gif")


tmmin <- ggplot(df_mensual2017, aes(x = PROVINCIA, y = TM_MIN, group = Meses)) +
  geom_line() +
  labs(title = 'Temperatura Media Minima por Provincia', x = 'Provincia', y = 'Temperatura Media Minima') +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

#transition_reveal(P_MES)
# Añade la animación por año
TMmin_animada <- tmmin + transition_states(Meses, transition_length = 2, state_length = 1)
anim_save("TMmin_animada.gif", animation = TMmin_animada, renderer = gifski_renderer())

browseURL("TMmin_animada.gif")

tmmax <- ggplot(df_mensual2017, aes(x = PROVINCIA, y = TM_MAX, group = Meses)) +
  geom_line() +
  labs(title = 'Temperatura Media Máxima por Provincia', x = 'Provincia', y = 'Temperatura Media Máxima') +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

#transition_reveal(P_MES)
# Añade la animación por año
TMmax_animada <- tmmax + transition_states(Meses, transition_length = 2, state_length = 1)
anim_save("TMmax_animada.gif", animation = TMmax_animada, renderer = gifski_renderer())

browseURL("TMmax_animada.gif")

hr <- ggplot(df_mensual2017, aes(x = PROVINCIA, y = HR, group = Meses)) +
  geom_line() +
  labs(title = 'Humedad Relativa por Provincia', x = 'Provincia', y = 'Humedad Relativa') +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

#transition_reveal(P_MES)
# Añade la animación por año
HR_animada <- hr + transition_states(Meses, transition_length = 2, state_length = 1)
anim_save("HR_animada.gif", animation = HR_animada, renderer = gifski_renderer())

browseURL("HR_animada.gif")


inso <- ggplot(df_mensual2017, aes(x = PROVINCIA, y = INSO, group = Meses)) +
  geom_line() +
  labs(title = 'Insolación por Provincia', x = 'Provincia', y = 'Insolación') +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

#transition_reveal(P_MES)
# Añade la animación por año
INSO_animada <- inso + transition_states(Meses, transition_length = 2, state_length = 1)
anim_save("INSO_animada.gif", animation = INSO_animada, renderer = gifski_renderer())

browseURL("INSO_animada.gif")


wm <- ggplot(df_mensual2017, aes(x = PROVINCIA, y = W_MED, group = Meses)) +
  geom_line() +
  labs(title = 'Viento Medio por Provincia', x = 'Provincia', y = 'Viento Medio') +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

#transition_reveal(P_MES)
# Añade la animación por año
WM_animada <- wm + transition_states(Meses, transition_length = 2, state_length = 1)
anim_save("WM_animada.gif", animation = WM_animada, renderer = gifski_renderer())

browseURL("WM_animada.gif")
```


#Graficas Anuales de interes
```{r}
dataset_anual_2 <- data.frame(df_anual2017$P_MES, df_anual2018$P_MES)
dataset_anual_3 <- data.frame(dataset_anual_2, df_anual2019$P_MES)
dataset_anual_4 <- data.frame(dataset_anual_3, df_anual2020$P_MES)
dataset_anual_5 <- data.frame(dataset_anual_4, df_anual2021$P_MES)
dataset_anual_precipitaciones <- data.frame(dataset_anual_5, df_anual2022$P_MES)
names(dataset_anual_precipitaciones) <- c("2017","2018","2019","2020","2021","2022")



datos_largo <- gather(dataset_anual_precipitaciones, key = "año", value = "precipitacion")


grafica1 <- ggplot(datos_largo, aes(x = precipitacion, y = año,  color = año)) +
  geom_line() +
  coord_flip() +
  scale_x_continuous(limits = c(0,550)) +
  labs(title = "Distribución de Precipitaciones por Año",
       x = "Precipitacion",  # Elimina la etiqueta del eje x
       y = "Año") +
  theme_minimal() +
  theme(axis.text.y  = element_text(angle = 90, hjust = 1))


grafica1

grafica_animada1 <- grafica1 + transition_reveal(precipitacion)
grafica_animada1
anim_save("grafica_animada1", animation = grafica_animada1, renderer = gifski_renderer())
browseURL("grafica_animada1.gif")



dataset_anual_2.1 <- data.frame(df_anual2017$TM_MES, df_anual2018$TM_MES)
dataset_anual_3.1 <- data.frame(dataset_anual_2.1, df_anual2019$TM_MES)
dataset_anual_4.1 <- data.frame(dataset_anual_3.1, df_anual2020$TM_MES)
dataset_anual_5.1 <- data.frame(dataset_anual_4.1, df_anual2021$TM_MES)
dataset_anual_temperaturas <- data.frame(dataset_anual_5.1, df_anual2022$TM_MES)
names(dataset_anual_temperaturas) <- c("2017","2018","2019","2020","2021","2022")

datos_largo.1 <- gather(dataset_anual_temperaturas, key = "año", value = "temperatura")



grafica2 <- ggplot(datos_largo.1, aes(x = temperatura, y = año, color = año)) +
  geom_line() +
  coord_flip() +
  scale_x_continuous(limits = c(0,35)) +
  labs(title = "Distribución de Temperatura por Año",
       xlab = "Años",
       ylab = "Temperatura") +
  theme_minimal() +
  theme(axis.text.y = element_text(angle = 90, hjust = 1))

grafica2

grafica_animada2 <- grafica2 + transition_reveal(temperatura)
grafica_animada2
anim_save("grafica_animada2.gif", animation = grafica_animada2, renderer = gifski_renderer())
browseURL("grafica_animada2.gif")

dataset_anual_2.2 <- data.frame(df_anual2017$INSO, df_anual2018$INSO)
dataset_anual_3.2 <- data.frame(dataset_anual_2.2, df_anual2019$INSO)
dataset_anual_4.2 <- data.frame(dataset_anual_3.2, df_anual2020$INSO)
dataset_anual_5.2 <- data.frame(dataset_anual_4.2, df_anual2021$INSO)
dataset_anual_inso <- data.frame(dataset_anual_5.2, df_anual2022$INSO)
names(dataset_anual_inso) <- c("2017","2018","2019","2020","2021","2022")

datos_largo.2 <- gather(dataset_anual_inso, key = "año", value = "insolacion")

grafica3 <- ggplot(datos_largo.2, aes(x = insolacion, y = año, color = año)) +
  geom_line() +
  coord_flip() +
  scale_x_continuous(limits = c(0,20)) +
  labs(title = "Distribución de Insolacion por Año",
       xlab = "Años",
       ylab = "Insolacion") +
  theme_minimal() +
  theme(axis.text.y = element_text(angle = 90, hjust = 1))

grafica3

grafica_animada3 <- grafica3 + transition_reveal(insolacion)
grafica_animada3
anim_save("grafica_animada3.gif", animation = grafica_animada3, renderer = gifski_renderer())
browseURL("grafica_animada3.gif")

```



# Conclusiones







