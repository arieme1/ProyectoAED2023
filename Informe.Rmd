---
title: "Informe"
author: "Mar Riveiro Cabado"
date: "`r Sys.Date()`"
<<<<<<< HEAD
output: 
  html_document:
    toc: true
  pdf_document:
    toc: true



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Introducción

En este proyecto de Análisis Exploratorio de Datos, haremos un estudio sobre las precipitaciones en España a lo largo de los últimos años. Los datos para conseguir un buen análisis de este tema, los hemos obtenido de la página de Instituto Nacional de Estadística (INE a partir de ahora): (*enlace*).

El objetivo de este trabajo es hacer un análisis de la variación de las precipitaciones a lo largo de los últimos años en todo el territorio español, ver la relación entre las distintas variables climáticas y evaluar si existen correlaciones significativas entre las mismas.

# Instalación y carga de librerías necesarias

Lo primero que hacemos es cargar todas las librerías que necesitaremos a lo largo del trabajo para una correcta ejecución.

```{r echo=TRUE}
rm(list=ls())
library(pacman)
packages = c("knitr", "ggplot2","gganimate","tidyr","dplyr","readr","GGally",
             "mice", "robustbase", "leaflet","gifski")
pacman::p_load(char=packages)
```

# Conjunto de datos

Antes de empezar con el análisis de todas las variables, hay que tener claro que sin un buen dataset ordenado no conseguiremos nada. Por lo tanto, este es nuestro primer objetivo.

Hemos descargado, desde la página del INE, varios archivos que contenían las mediciones de distintas variables meteorológicas en todo el territorio español, separadas por carpetas según el año correspondiente. Acompañando a todos estos archivos, hay un `Maestro_Climatológico` que identifica cada estación meteorológica del país con un indicativo, que es el  que aparece en los archivos de las variables identificando qué datos son de cada estación.

Primero, arreglamos el archivo `Maestro_Climatológico`, ya que lo necesitaremos también más adelante para la representación geoespacial.

```{r warning=FALSE, include=FALSE}

estaciones<-read_delim("./data/Maestro_Climatologico_2022.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE,show_col_types = FALSE)

agregar_separador <- function(numero, posicion) {
  # Convertir el número a cadena de caracteres
  numero_str <- as.character(numero)
  
  # Insertar el separador en la posición deseada
  numero_formateado <- paste0(
    substr(numero_str, 1, posicion),
    ".",
    substr(numero_str,posicion + 1, nchar(numero_str))
  )
  
  return(as.numeric(numero_formateado))
}

estaciones$LATITUD <- agregar_separador(estaciones$LATITUD, 2)
estaciones$LONGITUD <- agregar_separador(estaciones$LONGITUD, 1)

estaciones$LONGITUD<-estaciones$LONGITUD*(-1)


estaciones$LONGITUD[estaciones$PROVINCIA %in% c("TARRAGONA", "BARCELONA")] <-
  -estaciones$LONGITUD[estaciones$PROVINCIA %in% c("TARRAGONA", "BARCELONA")]

estaciones$LONGITUD[estaciones$PROVINCIA %in% c("LAS PALMAS", "SANTA CRUZ DE TENERIFE")] <-
  10*estaciones$LONGITUD[estaciones$PROVINCIA %in% 
                           c("LAS PALMAS", "SANTA CRUZ DE TENERIFE")]
```

Tras un primer visionado de los datos vemos que debido a la codificación existen caracteres erróneos en el *csv* desde el que cargamos las coordenadas de los municipios. Posteriormente, a la hora de elaborar un mapa interactivo, vemos que las coordenadas precisan una corrección de formato (separador decimal tras los primeros o segundos dígitos según sean longitud o latitud, respectivamente). Hacemos también unas correcciones de las coordenadas de Islas Canarias que aparecen desplazadas hacia la derecha con respecto a la localización correcta.


Nuestra idea principal ha sido la siguiente: crear un dataset por año con las variables que necesitamos para nuestro estudio. Hemos escogido `Humedad`, `Insolación`, `Velocidad del viento`, `Temperaturas mensuales`, `Precipitaciones mensuales`, `Temperaturas máximas mensuales` y `Temperaturas mínimas mensuales`.

```{r include=FALSE}
carpeta_base<-"./data/Variables/"

años<-2016:2022
lista_dataframes <- list()

for (año in años){
  
  ruta_carpeta<-file.path(carpeta_base, as.character(año))
  archivos_climaticos <- list.files(ruta_carpeta,pattern = ".*.csv")
  
  df_año<-data.frame(Indicativo = character(0), 
                     Meses = character(0), Valores= numeric(0))

  for (archivo in archivos_climaticos) {
    
    ruta_completa_archivo<-file.path(ruta_carpeta,archivo)
    variable <-read_delim(ruta_completa_archivo, delim = ";",
                          escape_double = FALSE, trim_ws=TRUE,
                          show_col_types=FALSE)
    prefijo <- substr(archivo, 1, nchar(archivo) - 9)
  
    df_variable <- variable %>%
        pivot_longer(col = -c(Indicativo), names_to = "Meses", 
                     values_to = prefijo) 
    
      if (archivo == archivos_climaticos[1]) {
          
        df_año <- df_variable
        
       } else {
         
        df_año <- left_join(df_año,df_variable,
                            by=join_by("Indicativo","Meses"))
       }
    
  }
    lista_dataframes[[as.character(año)]] <- df_año
    assign(paste0("df_", año), df_año, envir = .GlobalEnv)
    carpeta<-"./data/"
    nombre_archivo <- file.path(carpeta, paste0("dataset_",año,".csv"))
    write.csv(df_año, nombre_archivo, row.names = FALSE)
}

```

Hemos creado una lista (puede verse el código detallado en el fichero Rmd), donde cada elemento se corresponde con el Dataset de un año, por ejemplo el de $2022$:

```{r}
head(lista_dataframes[["2022"]])
```

La primera variable de este dataset es: `Indicativo`. A cada indicativo le corresponden 13 columnas con datos relativos al mismo, una por mes y la anual. Para construir este dataset, y por analogía el de los otros años, hemos tenido en consideración las siguientes las siguientes variables:

  * HR -> humedad relativa mensual/anual (%)
  * INSO -> Media mensual/anual de la insolación diaria (horas)
  * P_MES -> Precipitación total mensual/anual (mm)
  * TM_MAX -> Temperatura media mensual/anual de las máximas (°C)
  * TM_MES -> Temperatura media mensual/anual (°C)
  * TM_MIN -> Temperatura media mensual/anual de las mínimas (°C)

Los datos faltantes del dataset aparecen identificados como `NA`.

De todas las variables que aparecen en los repositorios de AEMET, hemos decidido analizar las arriba expuestas ya que consideramos que son las más representativas para nuestro estudio. De todas formas, adjuntamos en la carpeta del proyecto un *pdf* donde aparecen todas las variables a las que teníamos acceso.

Echamos un vistazo rápido a cómo son las características principales de nuestro dataset.


```{r}
glimpse(lista_dataframes[["2022"]])
```

Vemos que cada variable tiene varios datos faltantes, por lo que vamos a tratar los datos para suplir estas carencias y poder hacer un buen análisis.

Todas nuestras variables, a excepción del Indicativo y los Meses, que son categóricas, son variables numéricas. En particular, la velocidad del tiempo, *W_MED*, es una variable entera.

# Exploración Inicial de los datos

## Comprobación de datos faltantes e imputación

```{r eval=FALSE, include=FALSE}
faltan_2016<- colMeans(is.na(df_2016)) * 100

data_filtered <- df_2016 %>% filter(Meses != "anual") #filtro el dataset quitando los años

imputed_data_filtered <- mice(data_filtered, m = 5) #hago la imputación de datos con mice

imputed_data_2016 <- complete(imputed_data_filtered, action = 1) #introduzco los datos

filtered_rows <- df_2016 %>% filter(Meses == "anual") #tomo el dataset que solo contiene los "anual"

#ahora obtengo los valores anuales por indicativo para cada variable
columnas <- c("HR", "INSO","TM_MAX","TM_MES","TM_MIN","W_MED")
columnas2 <- c("P_MES")
columnas_F <- c("HR", "INSO","P_MES","TM_MAX","TM_MES","TM_MIN","W_MED")

#dataframe con los promedios anuales por indicativo
result <- imputed_data_2016 %>%
  group_by(Indicativo) %>%
  summarise(across(all_of(columnas), mean))

#dataframe con la suma anual de precipitaciones
result2 <-imputed_data_2016 %>%
  group_by(Indicativo)%>%
  summarise(across(all_of("P_MES"), sum))

#los uno y los ordeno conforme al original
df_2016_anual <- mutate(result, result2)
df_2016_anual <-df_2016_anual[,c("Indicativo","HR", "INSO","P_MES","TM_MAX","TM_MES","TM_MIN","W_MED")]

d_prueba<- imputed_data_2016 %>% group_by(Meses)

```

A partir de los dataset para cada año obtenidos de los originales para cada variable climatológica queremos costruir uno nuevo en el que además de recopilar dicha información, imputemos los valores correspondientes allá donde tenemos NA's. Esto lo haremos para cada año mediante un bucle, por el cuál separaremos los valores anuales de las variables (suma de los meses en el caso de las precipitaciones y promedio en el caso del resto de variables) del resto del dataset y crearemos un nuevo dataset para cada año donde se almacenen los valores anuales para cada Indicativo y cada variable. 

```{r include=FALSE}
#ANUAL
estaciones <- estaciones %>%
  rename(Indicativo = INDICATIVO)
Indicativos_maestro <- unique(unlist(estaciones[,"Indicativo"]))
años<-2016:2022
columnas <- c("HR", "INSO","TM_MAX","TM_MES","TM_MIN","W_MED")
columnas2 <- c("P_MES")
dataframes_anuales <- list()
dataframes_mensuales <- list()
i <- 2016

for (df in lista_dataframes){
  Indicativos_df <- unique(unlist(df[,"Indicativo"]))
  I_comunes <- intersect(Indicativos_df, Indicativos_maestro)
  
  Localizame <- estaciones[,c("Indicativo","PROVINCIA", "LONGITUD", "LATITUD", "MUNICIPIO")]
  Localizame <- Localizame%>%subset(Indicativo %in% I_comunes)

  data_filtered <- df %>% filter(Meses != "anual")%>%subset(Indicativo %in% I_comunes) 

  imputed_data_filtered <- mice(data_filtered, m = 20) 
  imputed_data <- complete(imputed_data_filtered, action = 1) 
#hago la imputación de datos con mice e introduzco los datos

  filtered_rows <- df %>% filter(Meses == "anual")%>%subset(Indicativo %in% I_comunes) 

  result <- imputed_data %>%group_by(Indicativo) %>%summarise(across(all_of(columnas), mean))

  result2 <-imputed_data %>%group_by(Indicativo)%>%summarise(across(all_of("P_MES"), sum))

  df_anual <- mutate(result, result2)
  df_anual<-df_anual[,c("Indicativo","HR","INSO","P_MES","TM_MAX","TM_MES","TM_MIN","W_MED")]
  df_anual <- merge(df_anual, Localizame, by = "Indicativo")
  nombre_df_a <- paste0("df_anual", i)
  dataframes_anuales[[nombre_df_a]] <- df_anual
  
  
  df_mensual <- merge(imputed_data, Localizame, by = "Indicativo")
  nombre_df_m <-paste0("df_mensual", i)
  dataframes_mensuales[[nombre_df_m]] <- df_mensual
  i<-i+1
}
list2env(dataframes_mensuales, envir = .GlobalEnv)
list2env(dataframes_anuales, envir = .GlobalEnv)
```

La imputación de datos se lleva a cabo mediante la librería $mice$, concretamente el método empleado por la librería para añadir los valores más coherentes es mediante la mediana de los datos de las variables para cada indicativo:

```{r}
summary(dataframes_mensuales[["df_mensual2022"]])
```

Una vez imputados los datos para los dataset que contienen la información mensual, adherimos las columnas de coordenadas, provincia y municipio para ubicar dichas estaciones espacialmente.

```{r eval=FALSE, include=FALSE}
head(df_mensual2022,6)
```

Es importante recordar que, a pesar de que sólo mostramos como ejemplo el dataset obtenido para 2022, en el archivo Rmd aparecen los mismos para los años anteriores hasta 2017.

## Visualización de los datos

Una vez imputados los `NA` estamos en posición de ver el aspecto de nuestros datos.

```{r echo=FALSE, warning=FALSE}
df_mensual2022$Meses <- factor(df_mensual2022$Meses, levels = c("enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"))
df_mensual2022 %>% 
  ggplot(aes(x = Meses, y = P_MES, fill = Meses)) +
  geom_bar(stat = "identity") +
  labs(title = "Precipitaciones mensuales 2022 (mm)", x = "Meses",
       y = "Precipitaciones") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+ theme(plot.margin = margin(1, 1, 2, 2, "cm"))
df_mensual2022 %>% 
  ggplot(aes(x = Meses , y = HR, fill=Meses)) +
  geom_bar(stat = "identity")  +
  labs(title = "Humedad (%)", x = "Meses", y = "Humedad relativa") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1),plot.margin = margin(1, 1, 2, 2, "cm"))
```

## Comprobación de outliers


```{r eval=FALSE, include=FALSE}
library(ggplot2)
library(gganimate)
factorizar_meses <- function(df) {
  df$Meses <- factor(df$Meses, levels = c("enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"))
  return(df)
}
nombres_dataframes <- c("df_mensual2016", "df_mensual2017", "df_mensual2018", "df_mensual2019", "df_mensual2020", "df_mensual2021", "df_mensual2022")

# Bucle for para factorizar la columna Meses en cada dataframe
for (nombre_df in nombres_dataframes) {
  # Obtener el dataframe por nombre
  df <- get(nombre_df)
  
  # Factorizar la columna Meses utilizando la función
  df_factorizado <- factorizar_meses(df)
  
  # Asignar el dataframe factorizado de vuelta al entorno global
  assign(nombre_df, df_factorizado)
}

grafico_outliers_pmes <- df_mensual2017 %>%
  ggplot(aes(x = PROVINCIA , y = P_MES)) +
  geom_boxplot() +
  labs(title = "Precipitaciones Medias por Provincia Outliers", x = "Provincia", y = "Precipitaciones") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1),plot.margin = margin(1, 1, 2, 2, "cm"))

grafico_outliers_pmes

grafico_outliers_inso <- df_mensual2017 %>%
  ggplot(aes(x = PROVINCIA , y = INSO)) +
  geom_boxplot() +
  labs(title = "Insolacion por Provincia Outliers", x = "Provincia", y = "Insolacion") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
grafico_outliers_inso

grafico_outliers_hr <- df_mensual2017 %>%
  ggplot(aes(x = PROVINCIA , y = HR)) +
  geom_boxplot() +
  labs(title = "Humedad Relativa por Provincia Outliers", x = "Provincia", y = "Humedad Relativa") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
grafico_outliers_hr

grafico_outliers_tmes <- df_mensual2017 %>%
  ggplot(aes(x = PROVINCIA , y = TM_MES)) +
  geom_boxplot() +
  labs(title = "Temperatura Medias por Provincia Outliers", x = "Provincia", y = "Temperatura") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
grafico_outliers_tmes

grafico_outliers_tmax <- df_mensual2017 %>%
  ggplot(aes(x = PROVINCIA , y = TM_MAX)) +
  geom_boxplot() +
  labs(title = "Tempereatura Maxima por Provincia Outliers", x = "Provincia", y = "Tempertura Maxima") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
grafico_outliers_tmax

grafico_outliers_tmin <- df_mensual2017 %>%
  ggplot(aes(x = PROVINCIA , y = TM_MIN)) +
  geom_boxplot() +
  labs(title = "Temperatura Minima por Provincia Outliers", x = "Provincia", y = "Temperatura Minima") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
grafico_outliers_tmin

grafico_outliers_wmed <- df_mensual2017 %>%
  ggplot(aes(x = PROVINCIA , y = W_MED)) +
  geom_boxplot() +
  labs(title = "Viento Medio por Provincia Outliers", x = "Provincia", y = "Viento") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
grafico_outliers_wmed

lista_outliers <- list()

for (df_names in names(dataframes_mensuales)) {
  df <- dataframes_mensuales[[df_names]]
  outliers_df <- list()
  
  for (i in names(df)) {
    outliers <- NULL
    
    if (is.numeric(df[[i]])) {
      if (any(!is.finite(df[[i]]))) {
        cat("Variable:", i, " contiene valores no finitos (NA, Inf, -Inf)\n")
      } else {
        iqr <- IQR(df[[i]], na.rm = TRUE)
        inferior <- quantile(df[[i]], c(0.25), na.rm = TRUE)
        superior <- quantile(df[[i]], c(0.75), na.rm = TRUE)
        
        cat("Variable:", i, "\t IQR:", iqr, "\t Inferior:", inferior, "\t Superior:", superior, "\n")
        
        outliers <- df[df[[i]] < (inferior - 1.5 * iqr) | df[[i]] > (superior + 1.5 * iqr), ]
        outliers_df[[i]] <- outliers
        
        cat("Variable:", i, "\t Outliers:", nrow(outliers), "\n")
      }
    }
  }
  
  lista_outliers[[df_names]] <- outliers_df
}
```


```{r echo=FALSE}
df_mensual2022 %>%
  ggplot(aes(x = PROVINCIA , y = P_MES, fill = PROVINCIA)) +
  geom_boxplot() +
  labs(title = "Precipitaciones Medias por Provincia Outliers",
       x = "Provincia", y = "Precipitaciones") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1), 
        legend.position = "none",plot.margin = margin(1, 1, 2, 2, "cm"))
```

De cara al estudio de los outliers, primero se decidió hacer una visualización mediante el graficado de distintos boxplot, para cada una de las variables, para el año 2022 (se puede observar lo mismo para el resto de variables y años en el .Rmd)

Tras la representación se definió una función para calcular todos los outliers de 2022, dicha función se define haciendo uso del método de boxplot, el cuál consiste en definir los cuantiles y los valores que se salgan tanto por el primer cuantil como por el tercer cuantil, que son los que la función determina como outliers. Una vez detectados los meses y las provincias de los outliers se investigó si dichos outliers eran coherentes en el contexto a estudiar. Tras una extensa búsqueda, se llegó a la conclusión de que dichos outliers podrían deberse a tormentas, olas de calor y más eventos climatológicos, por lo que consideramos no descartarlos para nuestro análisis. Sea como fuere, el estudio de estos outliers en concreto escapa de los objetivos de nuestro trabajo.


## Estadísticos

En este apartado calculamos para cada año y para cada Indicativo los estadísticos de cada variable: la media, la mediana, la desviación típica, el rango intercuartílico, y la desviación media absoluta.

Lo hacemos de dos formas distintas: primero calculamos los estadísticos para cada indicativo y después hacemos lo mismo pero para todo el territorio español y mensualmente. Igual que en el resto de apartados, almacenamos todos los resultados en una lista y en cada elemento de la lista se encuentran los datos para cada año.

```{r include=FALSE}
estadisticos_indicativo <- list()
estadisticos_meses <- list()

años <- 2017:2022

for (i in seq_along(dataframes_mensuales)) {
  df_año <- dataframes_mensuales[[i]]
  df_año$Meses <- factor(df_año$Meses, levels = c("enero", "febrero", "marzo", 
                                                       "abril", "mayo", "junio", "julio", "agosto" ,
                                                       "septiembre", "octubre", "noviembre",
                                                       "diciembre"))
  df_año$Indicativo <- factor(df_año$Indicativo)

  esta_por_indicativo <- df_año %>%
    group_by(Indicativo) %>%
    summarise(across(where(is.numeric), 
                     list(mean = ~mean(., na.rm = TRUE), 
                          sd = ~sd(., na.rm = TRUE), 
                          median = ~median(., na.rm = TRUE),
                          iqr = ~IQR(., na.rm = TRUE),
                          mad = ~mad(., constant = 1.4826))))

  nombre_ind <- paste0("esta_por_indicativo_", años[i])
  estadisticos_indicativo[[nombre_ind]] <- esta_por_indicativo

  esta_por_mes <- df_año %>%
    group_by(Meses) %>%
    summarise(across(where(is.numeric), 
                     list(mean = ~mean(., na.rm = TRUE), 
                          sd = ~sd(., na.rm = TRUE), 
                          median = ~median(., na.rm = TRUE),
                          iqr = ~IQR(., na.rm = TRUE),
                          mad = ~mad(., constant = 1.4826))))

  nombre_mes <- paste0("esta_por_mes_", años[i])
  estadisticos_meses[[nombre_mes]] <- esta_por_mes
}
```

Por ejemplo, los estadísticos para cada uno de los indicativos en el último año se tienen guardados de la siguiente manera:

```{r}
head(estadisticos_indicativo[["esta_por_indicativo_2022"]])
head(estadisticos_meses[["esta_por_mes_2022"]])
```

# Análisis Univariado

Tras el analisis de los outliers y los estadisticos de nuestro dataset, se empieza a hacer un estudio univariado de las distintas variables de interes.


El análisis univariante que podemos realizar para nuestro conjunto de datos está limitado a las variables numéricas, ya que no contamos con categóricas. El estudio más represenativo para nuestros datos consiste en estudiar la evolución de las precipitaciones y las temperaturas mensuales para los últimos años.


```{r echo=FALSE, warning=FALSE}
#COMPLETO 2016:2022
library(ggthemes)

lluvias_2022 <- df_mensual2022 %>% group_by(Meses)%>% summarise(prom_HR = mean(P_MES))%>%mutate(Año = 2022)
lluvias_2021 <- df_mensual2021 %>% group_by(Meses)%>% summarise(prom_HR = mean(P_MES))%>%mutate(Año = 2021)
lluvias_2020 <- df_mensual2020 %>% group_by(Meses)%>% summarise(prom_HR = mean(P_MES))%>%mutate(Año = 2020)
lluvias_2019 <- df_mensual2019 %>% group_by(Meses)%>% summarise(prom_HR = mean(P_MES))%>%mutate(Año = 2019)
lluvias_2018 <- df_mensual2018 %>% group_by(Meses)%>% summarise(prom_HR = mean(P_MES))%>%mutate(Año = 2018)
lluvias_2017 <- df_mensual2017 %>% group_by(Meses)%>% summarise(prom_HR = mean(P_MES))%>%mutate(Año = 2017)


lluvias <- bind_rows(lluvias_2022,lluvias_2021, lluvias_2020,lluvias_2019)
lluvias$Meses <- factor(lluvias$Meses, levels = c("enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto" ,"septiembre", "octubre", "noviembre", "diciembre"))

# Crea el gráfico de línea

precipitaciones = ggplot(lluvias, aes(x = Meses, y = prom_HR, group = Año))+geom_line(aes(linetype =  factor(Año),color=factor(Año)),size = 1.3, alpha = 0.7) + labs(title = "Promedio mensual de precipitaciones", subtitle = "España 2022", x = "Meses", y = "Precipitaciones (mm)")+ theme_fivethirtyeight() + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + theme(legend.title=element_blank())
precipitaciones

```


En esta primera grafica se representa la variacion de las temperaturas a lo largo de los meses para los años 2019,2020,2021,2022. Se puede observar una clara tendencia de disminución entre los meses más calientes, mientras que cuando se acerca el otoño y el invierno las precipitaciones aumentan.
Otra cosa destacable es que a medida que pasan los años se puede observar que las precipitaciones aumentan de manera general.

Puede apreciarse una bajada considerable de las precipitaciones en España en 2022 con respecto a los dos últimos años anteriores, equiparándose a las precipitaciones del año 2019. Análogamente con las temperaturas máxima y media.

```{r warning=FALSE, include=FALSE}
tmax_2022 <- df_mensual2022 %>% group_by(Meses)%>%summarise(prom_tmax = mean(TM_MAX))%>%mutate(Año = 2022)
tmax_2021 <- df_mensual2021 %>% group_by(Meses)%>%summarise(prom_tmax = mean(TM_MAX))%>%mutate(Año = 2021)
tmax_2020 <- df_mensual2020 %>% group_by(Meses)%>%summarise(prom_tmax = mean(TM_MAX))%>%mutate(Año = 2020)
tmax_2019 <- df_mensual2019 %>% group_by(Meses)%>%summarise(prom_tmax = mean(TM_MAX))%>%mutate(Año = 2019)
tmax_2018 <- df_mensual2018 %>% group_by(Meses)%>%summarise(prom_tmax = mean(TM_MAX))%>%mutate(Año = 2018)
tmax_2017 <- df_mensual2017 %>% group_by(Meses)%>%summarise(prom_tmax = mean(TM_MAX))%>%mutate(Año = 2017)

tmaximas <- bind_rows(tmax_2022, tmax_2021, tmax_2020,tmax_2019)
tmaximas$Meses <- factor(tmaximas$Meses, levels = c("enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto" ,"septiembre", "octubre", "noviembre", "diciembre"))

maximas = ggplot(tmaximas, aes(x = Meses, y = prom_tmax, group = Año))+geom_line(aes(linetype =  factor(Año),color=factor(Año)),size = 1, alpha = 0.7) + labs(title = "Temperaturas máximas", subtitle = "España 2022", x = "Meses", y = "Temperatura (ºC)")+ theme_fivethirtyeight() + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + theme(legend.title=element_blank()) + scale_color_brewer(palette = "PuOr")
maximas
```

```{r warning=FALSE, include=FALSE}
tmed_2022 <- df_mensual2022 %>% group_by(Meses)%>%summarise(prom_tmed = mean(TM_MES))%>%mutate(Año = 2022)
tmed_2021 <- df_mensual2021 %>% group_by(Meses)%>%summarise(prom_tmed = mean(TM_MES))%>%mutate(Año = 2021)
tmed_2020 <- df_mensual2020 %>% group_by(Meses)%>%summarise(prom_tmed = mean(TM_MES))%>%mutate(Año = 2020)
tmed_2019 <- df_mensual2019 %>% group_by(Meses)%>%summarise(prom_tmed = mean(TM_MES))%>%mutate(Año = 2019)
tmed_2018 <- df_mensual2018 %>% group_by(Meses)%>%summarise(prom_tmed = mean(TM_MES))%>%mutate(Año = 2018)
tmed_2017 <- df_mensual2017 %>% group_by(Meses)%>%summarise(prom_tmed = mean(TM_MES))%>%mutate(Año = 2017)

tmed <- bind_rows(tmed_2022, tmed_2021, tmed_2020,tmed_2019)
tmed$Meses <- factor(tmed$Meses, levels = c("enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto" ,"septiembre", "octubre", "noviembre", "diciembre"))

medias = ggplot(tmed, aes(x = Meses, y = prom_tmed, group = Año))+geom_line(aes(linetype =  factor(Año),color=factor(Año)),size = 1, alpha = 0.7) + labs(title = "Temperaturas medias", subtitle = "España 2022", x = "Meses", y = "Temperatura (ºC)")+ theme_fivethirtyeight() + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + theme(legend.title=element_blank()) + scale_color_brewer(palette = "Set2")
medias
```

En las dos gráficas anteriores se puede observar tanto la temperatura máxima como la temperatura media a lo largo de los años en toda España, se observa que los meses mas cálidos son de septiembre a agosto mientras que en el resto de meses la temperatura disminuye por debajo de los 15 grados. 


Al comparar con los resúmenes estacionales climatológicos de AEMET para 2022 [*] (referenciar) vemos que los datos que representamos se mantienen coherentes con los expuestos en los resúmenes oficiales, por lo que nos inclinamos a pensar que la imputación de los datos por parte de la librería empleada es válida.


# Análisis Bivariado

Después de análizar cada una de las variables individualmente, tiene sentido pensar que algunas de ellas guardan cierto grado de relación entre ellas. Es el punto de estudiar esta relación. Empezamos con un análisis numérico, para ello calculamos la matriz de Correlación de Pearson, la matriz de Correlación de Spearman y la matriz de Covarianzas para cada uno de los años.

```{r warning=FALSE, include=FALSE}
correlacion_pearson <- list()
correlacion_spearman <- list()
covarianzas <- list()
años <- 2017:2022

for (i in seq_along(dataframes_mensuales)) {
  df_año <- dataframes_mensuales[[i]]
  df_año$Indicativo <- factor(df_año$Meses, levels = c("enero", "febrero", "marzo", 
                                                       "abril", "mayo", "junio", "julio", "agosto" ,
                                                       "septiembre", "octubre", "noviembre",
                                                       "diciembre"))
  df_año$Meses <- factor(df_año$Meses)
  
  variables_año <- df_año[, c("HR", "INSO", "P_MES", "TM_MAX", "TM_MES", "TM_MIN", "W_MED")]
  
  correlacion_pearson_ <- cor(variables_año, method = "pearson", use = "complete.obs")
  nombre_corp <- paste0("correlacion_pearson_", años[i])
  correlacion_pearson[[nombre_corp]] <- correlacion_pearson_
  
  correlacion_spearman_ <- cor(variables_año, method = "spearman", use = "complete.obs")
  nombre_cors <- paste0("correlacion_spearman_", años[i])
  correlacion_spearman[[nombre_cors]] <- correlacion_spearman_

  covarianzas_ <- cov(variables_año, use = "complete.obs")
  nombres_cov <- paste0("covarianzas_", años[i])
  covarianzas[[nombres_cov]] <- covarianzas_
}

```

Hemos almacenado en las listas `correlacion_pearson`, `correlacion_spearman` y `covarianzas` las matrices correspondientes, cada elemento de cada lista se corresponde con la respectiva matriz relativa a cada año de nuestro estudio. Analizaremos estos resultado más adelante, primero veamos estos resultados año por año gráficamente con la función `corrplot`. 


```{r warning=FALSE, include=FALSE}
# Configurar el diseño de la ventana gráfica
par(mfrow = c(3, 3))
library(corrplot)
for (año in años) {
  corrplot(correlacion_pearson[[paste0("correlacion_pearson_", año)]], 
           method = "color", type = "lower", diag = FALSE)
}

# Restaurar la configuración original de la ventana gráfica
par(mfrow = c(1, 1))

```


Vemos que la correlación entre las variables son prácticamente iguales para cada año, por lo tanto, vamos a centrarnos en los datos del año $2022$, para realizar un análisis más concreto y preciso.


```{r}
corrplot(correlacion_pearson[["correlacion_pearson_2022"]], type = "lower", diag = FALSE)
```

Para entender un poco mejor lo que nos quiere decir esta gráfica, cuan más grande es el círculo situado en las correspondientes casillas de las variables, más fuerte es la relación entre ellas (en azul si dicha correlación es lineal positiva y en rojo si es negativa). Cuanto más se reduce el tamaño del círculo, esto indica que la correlación entre las variables disminuye.

Por lo tanto, las conclusiones que extraemos de analizar este gráfico son las siguientes:

* La velocidad del viento, *W_MED*, no está prácticamente correlacionada con el resto de variables, por lo que la apartarmos de momento de nuestro estudio.

* Las variables *T_MAX*, *T_MIN* y *T_MES*, que recordamos que hacían referencia a:

  * TM_MAX -> Temperatura media mensual/anual de las máximas (°C)
  * TM_MES -> Temperatura media mensual/anual (°C)
  * TM_MIN -> Temperatura media mensual/anual de las mínimas (°C)
  
  Claramente estas variables están fuertemente correlacionadas, lo cual es lógico y natural, ya que estamos hablando de lo mismo, temperaturas, pero dando un dato distinto cada una de ellas.
  
* Por lo demás, las relaciones más destacables (teniendo en cuenta el objetivo de nuestro estudio) que extraemos del gráfico son las siguientes:

  * Insolacion y Precipitaciones medias mensuales.
  * Insolacion y Humedad.
  * Temperatura máxima y Precipitaciones medias mensuales.
  * Temperatura máxima y Humedad.
  * Temperatura máxima e Insolacion

Además de centrarnos en el gráfico, echemos un ojo a la matriz de correlaciones, tanto de Pearson como la de Spearman y la matriz de covarianzas.


* Coeficiente de Correlación de Pearson: Mide la fuerza y dirección de una relación lineal.

```{r echo=FALSE}
correlacion_pearson[["correlacion_pearson_2022"]]
```

* Coeficiente de Correlación de Spearman: Evalúa la relación monótona entre las dos variables consideradas.

```{r echo=FALSE}
correlacion_spearman[["correlacion_spearman_2022"]]
```

```{r eval=FALSE, include=FALSE}
covarianzas[["covarianzas_2022"]]
```

Iniciamos el analisis de la correlacion para el año $2022$:


```{r include=FALSE}
d_22<-dataframes_mensuales[["df_mensual2022"]]
HR<-dataframes_mensuales[["df_mensual2022"]]%>%
  select(Indicativo,Meses,HR)
P_MES<-dataframes_mensuales[["df_mensual2022"]]%>%
  select(Indicativo,Meses,P_MES)
INSO<-dataframes_mensuales[["df_mensual2022"]]%>%
  select(Indicativo,Meses,INSO)
T_MAX<-dataframes_mensuales[["df_mensual2022"]]%>%
  select(Indicativo,Meses,TM_MAX)
T_MES<-dataframes_mensuales[["df_mensual2022"]]%>%
  select(Indicativo,Meses,TM_MES)
```

```{r eval=FALSE, warning=FALSE, include=FALSE}
correlation_matrix <- cor(d_22[, c("HR", "P_MES", "INSO", "TM_MAX")])
heatmap(correlation_matrix)
```


```{r echo=FALSE, warning=FALSE}
library(viridis)  # Para paletas de colores

# Crear un factor para los niveles de precipitación
d_22$Precipitation_Level <- cut(d_22$P_MES, breaks = 3)

# Boxplot con ggplot2
ggplot(d_22, aes(x = Precipitation_Level, y = INSO, fill = Precipitation_Level)) +
  geom_boxplot(color = "black", outlier.shape = NA) +  # Estilo del boxplot
  scale_fill_viridis(discrete = TRUE) +  # Paleta de colores
  labs(title = "Boxplot de Insolación por Niveles de Precipitación",
       x = "Niveles de Precipitación",
       y = "Insolación") +
  theme_minimal() +  # Estilo del tema
  theme(axis.text.x = element_text(angle = 45, hjust = 1),plot.margin = margin(1, 1, 2, 2, "cm"))

```

```{r echo=FALSE, message=FALSE}
library(ggplot2)
ggplot(d_22, aes(x=INSO, y=HR)) +
  geom_point(colour = "skyblue") +
  geom_smooth(method="lm", se=FALSE, color="red") +
  labs(title="Scatter Plot con Línea de Regresión (Insolacion vs Humedad)",
       x="Insolación", y="Humedad relativa") + 
  theme(plot.margin = margin(1, 1, 2, 2, "cm"))

```


```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(d_22, aes(x=HR, y=TM_MAX)) +
<<<<<<< HEAD
  geom_violin() +
=======
  geom_bar() +
>>>>>>> 5abf5557926ba4c39323e05f8828e2ee359a076a
  labs(title="Diagrama de Violín (Temperatura máxima vs Humedad)", x="Humedad", y="Insolación", fill="Humedad")+ 
  theme(plot.margin = margin(1, 1, 2, 2, "cm"))
```

```{r}
ggplot(d_22, aes(x=TM_MAX, y=INSO, size=INSO)) +
  geom_point(alpha=0.5,col="red",fill="black") +
  labs(title="Gráfico de Burbujas (Temperatura Máxima vs Insolación)",
       x="Temperaturas", y="Insolación", size="Temperaturas") +
  theme(plot.margin = margin(1, 1, 2, 2, "cm"))
```

  
```{r message=FALSE}
library(GGally)
pares<-dataframes_mensuales[["df_mensual2022"]]%>%
  select(HR,INSO,P_MES,TM_MAX,TM_MES,TM_MIN)
ggpairs(pares)
```

Con las representaciones hechas para continuar el análiss de correlación entre variables, reafirmamos las conclusiones obtenidas tras el análisis del diagrama del gráfico de correlaciones.




```{r}
library(ggplot2)
ggplot(d_22, aes(x=TM_MES, y=P_MES)) +
  geom_point(colour = "skyblue")  +
  labs(x="Insolación", y="Humedad relativa") + 
  theme(plot.margin = margin(1, 1, 2, 2, "cm"))
```

# Conclusiones

Tras el análisis que hemos hecho de los datos de los que partíamos, y teniendo en cuenta que nuestro objetivo era analizar la variación de las  precipitaciones y la temperatura en el territorio español.

Al comparar con los resúmenes estacionales climatológicos de AEMET para 2022 vemos que los datos que representamos se mantienen coherentes con los expuestos en los resúmenes oficiales, por lo que nos inclinamos a pensar que la imputación de los datos por parte de la librería empleada es válida.

Puede apreciarse una bajada considerable de las precipitaciones en España en 2022 con respecto a los dos últimos años anteriores, equiparándose a las precipitaciones del año 2019 que se corresponden con las épocas de sequía.

Por otra parte, hemos comprobado que las rachas de viento que atraviesan España en cada una de las comunidades no guarda relación con la temperatura y las precipitaciones, ni con ninguna de las otras variables de estudio, por lo que pueden descartarse del análisis.

La `Insolación` se relaciona con la `Temperatura` de forma lineal con correlación positiva como era de esperar: zonas con mayor exposición solar diaria tienden a tener unas temperaturas generalmente mayores que las zonas que cuentan con menos horas de sol. Lo contrario ocurre entre la `Insolación` y las `Precipitaciones`, que muestran una relación lineal negativa. Puede entenderse este caso en zonas de España como Galicia, que cuenta con un mayor índice de precipitaciones a lo largo del año y a su vez tiene menos horas de sol (mayor nubosidad).


```{r}

lista_datasets <- list(df_mensual2022,df_mensual2021,df_mensual2020,df_mensual2019,df_mensual2018,df_mensual2017)
resultados_precipitaciones <- list()
resultados_temperatura <- list()

for (i in seq_along(lista_datasets)) {
 
  datos_actual <- lista_datasets[[i]]
  
  
  maximos_por_provincia_mes <- datos_actual %>%
    group_by(PROVINCIA, Meses) %>%
    summarize(Max_Precipitacion = max(P_MES, na.rm = TRUE))  
  
 
  resultados_precipitaciones[[i]] <- maximos_por_provincia_mes
}

for (i in seq_along(lista_datasets)) {
 
  datos_actual2 <- lista_datasets[[i]]
  
  
  maximos_por_provincia_mes2 <- datos_actual2 %>%
    group_by(PROVINCIA, Meses) %>%
    summarize(Max_Temperatura = max(TM_MES, na.rm = TRUE))  
  
 
  resultados_temperatura[[i]] <- maximos_por_provincia_mes2
}


nombres_dataframes1 <- paste0("df_precipitaciones", seq_along(resultados_precipitaciones))  # Nombres para los dataframes

list2env(setNames(resultados_precipitaciones, nombres_dataframes1), envir = .GlobalEnv)

nombres_dataframes2 <- paste0("df_temperaturas", seq_along(resultados_temperatura))  # Nombres para los dataframes

list2env(setNames(resultados_temperatura, nombres_dataframes2), envir = .GlobalEnv)

library(dplyr)

# # Crear una lista con los nombres de los dataframes
# lista_dataframes <- mget(ls(pattern = "df_precipitaciones\\d+"))  # Obtener los dataframes con nombres df_1, df_2, ...
# 
# # Unir los dataframes en un único dataframe
# resultado_final <- bind_rows(lista_dataframes, .id = "Año")
# resultado_final$Año <- factor(resultado_final$Año)


p8 <- ggplot(df_precipitaciones1, aes(x = PROVINCIA, y = Max_Precipitacion, color = Meses)) + 
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)
        ,plot.margin = margin(1, 1, 2, 2, "cm"))
p8

p6 <-ggplot(df_temperaturas1, aes(x = PROVINCIA, y = Max_Temperatura, color = Meses)) + 
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)
        ,plot.margin = margin(1, 1, 2, 2, "cm"))


p6

```

```{r}
ggplot(df_precipitaciones1, aes(x = PROVINCIA, y = Max_Precipitacion, color = Meses)) + 
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)
        ,plot.margin = margin(1, 1, 2, 2, "cm"))


ggplot(df_temperaturas1, aes(x = PROVINCIA, y = Max_Temperatura, color = Meses)) + 
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)
        ,plot.margin = margin(1, 1, 2, 2, "cm"))

```

En estas gráficas se puede observar que que los meses con mayor numero de precipitaciones son en el mes de Diciembre y la provincia donde mas llueve es en Ourense. Mientras que para las temperaturas se observa que los meses mas calidos seria Agosto y manteniendo un constante en toda España.

# Anexo

## Mapa Interactivo

En el mapa interactivo se muestran las estaciones meteorológicas donde se tomaron los datos para cada año correspondiente. Mostramos el municipio donde se ubican y algunas variables anuales de las mismas.

```{r echo=FALSE}


mapa_espana <- leaflet() %>%
  addTiles() %>%
  setView(lng = -4, lat = 40, zoom = 6) %>% addCircles(lng = df_anual2022$LONGITUD, lat = df_anual2022$LATITUD, data = df_anual2022,radius = 5, popup = paste0(
  df_anual2022$MUNICIPIO,"<hr>",
  "T. Med (ºC):", round(df_anual2022$TM_MES,1),"<br>",
  "T. Max (ºC):", round(df_anual2022$TM_MAX,1),"<br>",
  "Precipitaciones (mm):", round(df_anual2022$P_MES),"<br>",
  "Insolación (horas):", round(df_anual2022$INSO,1)))

# Muestra el mapa
mapa_espana



```

## Gráficos Animados
En estas graficas se pueden observar las variaciones mensuales de las variables de interes de nuestro estudio para las provincias del territorio español.

```{r echo=FALSE}
#Graficas animadas para cada mes

p <- ggplot(df_mensual2017, aes(x = PROVINCIA, y = P_MES, group = Meses)) +
  geom_line() +
  labs(title = 'Precipitaciones por Provincia (mm)', x = 'Provincia', y = 'Precipitaciones') +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


# Añade la animación por año
p_animada <- p + transition_states(Meses, transition_length = 2, state_length = 3)
anim_save("p_animada.gif", animation = p_animada, renderer = gifski_renderer())

browseURL("p_animada.gif")
```


```{r eval=FALSE, include=FALSE}
tmes <- ggplot(df_mensual2017, aes(x = PROVINCIA, y = TM_MES, group = Meses)) +
  geom_line() +
  labs(title = 'Temperatura Media por Provincia (ºC)', x = 'Provincia', y = 'Temperatura Media') +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

#transition_reveal(P_MES)
# Añade la animación por año
TMes_animada <- tmes + transition_states(Meses, transition_length = 4, state_length = 3)
anim_save("TMes_animada.gif", animation = TMes_animada, renderer = gifski_renderer())

browseURL("TMes_animada.gif")

```

```{r echo=FALSE}
hr <- ggplot(df_mensual2017, aes(x = PROVINCIA, y = HR, group = Meses)) +
  geom_line() +
  labs(title = 'Humedad Relativa por Provincia (%)', x = 'Provincia', y = 'Humedad Relativa') +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

#transition_reveal(P_MES)
# Añade la animación por año
HR_animada <- hr + transition_states(Meses, transition_length = 4, state_length = 3)
anim_save("HR_animada.gif", animation = HR_animada, renderer = gifski_renderer())

browseURL("HR_animada.gif")
```

```{r echo=FALSE}
inso <- ggplot(df_mensual2017, aes(x = PROVINCIA, y = INSO, group = Meses)) +
  geom_line() +
  labs(title = 'Insolación por Provincia (Horas)', x = 'Provincia', y = 'Insolación') +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

#transition_reveal(P_MES)
# Añade la animación por año
INSO_animada <- inso + transition_states(Meses, transition_length = 4, state_length = 3)
anim_save("INSO_animada.gif", animation = INSO_animada, renderer = gifski_renderer())

browseURL("INSO_animada.gif")
```


En la primera gráfica, en la que se observan las precipitaciones, se tiene que los picos de mayor lluvia ocurren en los meses de Enero,Febrero,Noviembre y Diciembre y las zonas donde mas lluvias ocurren seria en las provincias mas al norte de España.

Por otro lado en la gráfica dos se representa la temperatura media, donde los picos de mayor calor ocurren en los meses de Junio, Julio, Agosto en las provincias mas al sur de España.

En la tercera gráfica, en la que se puede apreciar la humedad relativa, se observa que la humedad varia bastante en funcion de cada mes, pero las provincias que mas resaltan son  Cantabria y Lugo

Para la cuarta gráfica se observa las insolacion, que varia bastante en funcion de la epoca del año destacando más en los meses de Junio, Julio y Agosto.











