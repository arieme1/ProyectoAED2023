---
title: "Estadisticos y anallisis bivariante"
author: "Mar Riveiro Cabado"
date: "`r Sys.Date()`"
output: html_document
---

En primer lugar, y antes de empezar con el análisis, cargamos todas las librerías que necesitaremos a lo largo del estudio.

```{r}
rm(list=ls())
library(pacman)
packages = c("knitr", "ggplot2","tidyr","dplyr","readr","GGally", "mice", "robustbase","leaflet","maps","corrplot","gridExtra")
pacman::p_load(char=packages)
options(ggplot2.show.progress = FALSE)
```


```{r}
#Cargamos el documento Maestro_Climatologico y lo almacenamos en estaciones.

estaciones<-read_delim("./data/Maestro_Climatologico_2022.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE,show_col_types = FALSE)

agregar_separador <- function(numero, posicion) {
  # Convertir el número a cadena de caracteres
  numero_str <- as.character(numero)
  
  # Insertar el separador en la posición deseada
  numero_formateado <- paste0(
    substr(numero_str, 1, posicion),
    ".",
    substr(numero_str,posicion + 1, nchar(numero_str))
  )
  
  # Devolver el resultado como número
  return(as.numeric(numero_formateado))
}

estaciones$LATITUD <- agregar_separador(estaciones$LATITUD, 2)
estaciones$LONGITUD <- agregar_separador(estaciones$LONGITUD, 1)

estaciones$LONGITUD<-estaciones$LONGITUD*(-1)


estaciones$LONGITUD[estaciones$PROVINCIA %in% c("TARRAGONA", "BARCELONA")] <- -estaciones$LONGITUD[estaciones$PROVINCIA %in% c("TARRAGONA", "BARCELONA")]
```


```{r}
carpeta_base<-"./data/Variables/"

años<-2016:2022
lista_dataframes <- list()

for (año in años){
  
  ruta_carpeta<-file.path(carpeta_base, as.character(año))
  archivos_climaticos <- list.files(ruta_carpeta,pattern = ".*.csv")
  
  df_año<-data.frame(Indicativo = character(0), 
                     Meses = character(0), Valores= numeric(0))

  for (archivo in archivos_climaticos) {
    
    ruta_completa_archivo<-file.path(ruta_carpeta,archivo)
    variable <-read_delim(ruta_completa_archivo, delim = ";",
                          escape_double = FALSE, trim_ws=TRUE,
                          show_col_types=FALSE)
    prefijo <- substr(archivo, 1, nchar(archivo) - 9)
  
    df_variable <- variable %>%
        pivot_longer(col = -c(Indicativo), names_to = "Meses", 
                     values_to = prefijo) 
    
      if (archivo == archivos_climaticos[1]) {
          
        df_año <- df_variable
        
       } else {
         
        df_año <- left_join(df_año,df_variable,
                            by=join_by("Indicativo","Meses"))
       }
    
  }
    lista_dataframes[[as.character(año)]] <- df_año
    assign(paste0("df_", año), df_año, envir = .GlobalEnv)
    carpeta<-"./data/"
    nombre_archivo <- file.path(carpeta, paste0("dataset_",año,".csv"))
    write.csv(df_año, nombre_archivo, row.names = FALSE)
}

```

## CODEBOOK

Variables:

  * HR -> humedad relativa mensual/anual (%)
  * INSO -> Media mensual/anual de la insolación diaria (horas)
  * P_MES -> Precipitación total mensual/anual (mm)
  * TM_MAX -> Temperatura media mensual/anual de las máximas (°C)
  * TM_MES -> Temperatura media mensual/anual (°C)
  * TM_MIN -> Temperatura media mensual/anual de las mínimas (°C)

```{r}
faltan_2016<- colMeans(is.na(df_2016)) * 100

data_filtered <- df_2016 %>% filter(Meses != "anual") #filtro el dataset quitando los años

imputed_data_filtered <- mice(data_filtered, m = 5) #hago la imputación de datos con mice

imputed_data_2016 <- complete(imputed_data_filtered, action = 1) #introduzco los datos

filtered_rows <- df_2016 %>% filter(Meses == "anual") #tomo el dataset que solo contiene los "anual"

#ahora obtengo los valores anuales por indicativo para cada variable
columnas <- c("HR", "INSO","TM_MAX","TM_MES","TM_MIN","W_MED")
columnas2 <- c("P_MES")
columnas_F <- c("HR", "INSO","P_MES","TM_MAX","TM_MES","TM_MIN","W_MED")

#dataframe con los promedios anuales por indicativo
result <- imputed_data_2016 %>%
  group_by(Indicativo) %>%
  summarise(across(all_of(columnas), mean))

#dataframe con la suma anual de precipitaciones
result2 <-imputed_data_2016 %>%
  group_by(Indicativo)%>%
  summarise(across(all_of("P_MES"), sum))

#los uno y los ordeno conforme al original
df_2016_anual <- mutate(result, result2)
df_2016_anual <-df_2016_anual[,c("Indicativo","HR", "INSO","P_MES","TM_MAX","TM_MES","TM_MIN","W_MED")]

d_prueba<- imputed_data_2016 %>% group_by(Meses)

```



```{r}
#ANUAL
estaciones <- estaciones %>%
  rename(Indicativo = INDICATIVO)
Indicativos_maestro <- unique(unlist(estaciones[,"Indicativo"]))
años<-2016:2022
columnas <- c("HR", "INSO","TM_MAX","TM_MES","TM_MIN","W_MED")
columnas2 <- c("P_MES")
dataframes_anuales <- list()
dataframes_mensuales <- list()
i <- 2016

for (df in lista_dataframes){
  Indicativos_df <- unique(unlist(df[,"Indicativo"]))
  I_comunes <- intersect(Indicativos_df, Indicativos_maestro)
  
  Localizame <- estaciones[,c("Indicativo","PROVINCIA", "LONGITUD", "LATITUD")]
  Localizame <- Localizame%>%subset(Indicativo %in% I_comunes)

  data_filtered <- df %>% filter(Meses != "anual")%>%subset(Indicativo %in% I_comunes) 

  imputed_data_filtered <- mice(data_filtered, m = 5) 
  imputed_data <- complete(imputed_data_filtered, action = 1) 
#hago la imputación de datos con mice e introduzco los datos

  filtered_rows <- df %>% filter(Meses == "anual")%>%subset(Indicativo %in% I_comunes) 

  result <- imputed_data %>%group_by(Indicativo) %>%summarise(across(all_of(columnas), mean))

  result2 <-imputed_data %>%group_by(Indicativo)%>%summarise(across(all_of("P_MES"), sum))

  df_anual <- mutate(result, result2)
  df_anual<-df_anual[,c("Indicativo","HR","INSO","P_MES","TM_MAX","TM_MES","TM_MIN","W_MED")]
  df_anual <- merge(df_anual, Localizame, by = "Indicativo")
  nombre_df_a <- paste0("df_anual", i)
  dataframes_anuales[[nombre_df_a]] <- df_anual
  
  
  df_mensual <- merge(imputed_data, Localizame, by = "Indicativo")
  nombre_df_m <-paste0("df_mensual", i)
  dataframes_mensuales[[nombre_df_m]] <- df_mensual
  i<-i+1
}
```


## Estadísticos

```{r}
estadisticos_indicativo <- list()
estadisticos_meses <- list()

años <- 2016:2022

for (i in seq_along(dataframes_mensuales)) {
  df_año <- dataframes_mensuales[[i]]
  df_año$Indicativo <- factor(df_año$Meses, levels = c("enero", "febrero", "marzo", 
                                                       "abril", "mayo", "junio", "julio", "agosto" ,
                                                       "septiembre", "octubre", "noviembre",
                                                       "diciembre"))
  df_año$Meses <- factor(df_año$Meses)

  esta_por_indicativo <- df_año %>%
    group_by(Indicativo) %>%
    summarise(across(where(is.numeric), 
                     list(mean = ~mean(., na.rm = TRUE), 
                          sd = ~sd(., na.rm = TRUE), 
                          median = ~median(., na.rm = TRUE),
                          iqr = ~IQR(., na.rm = TRUE),
                          mad = ~mad(., constant = 1.4826))))

  nombre_ind <- paste0("esta_por_indicativo_", años[i])
  estadisticos_indicativo[[nombre_ind]] <- esta_por_indicativo

  esta_por_mes <- df_año %>%
    group_by(Meses) %>%
    summarise(across(where(is.numeric), 
                     list(mean = ~mean(., na.rm = TRUE), 
                          sd = ~sd(., na.rm = TRUE), 
                          median = ~median(., na.rm = TRUE),
                          iqr = ~IQR(., na.rm = TRUE),
                          mad = ~mad(., constant = 1.4826))))

  nombre_mes <- paste0("esta_por_mes_", años[i])
  estadisticos_meses[[nombre_mes]] <- esta_por_mes
}


```



# Análisis Bivariado

```{r}
correlacion_pearson <- list()
correlacion_spearman <- list()
covarianzas <- list()
años <- 2016:2022

for (i in seq_along(dataframes_mensuales)) {
  df_año <- dataframes_mensuales[[i]]
  df_año$Indicativo <- factor(df_año$Meses, levels = c("enero", "febrero", "marzo", 
                                                       "abril", "mayo", "junio", "julio", "agosto" ,
                                                       "septiembre", "octubre", "noviembre",
                                                       "diciembre"))
  df_año$Meses <- factor(df_año$Meses)
  
  variables_año <- df_año[, c("HR", "INSO", "P_MES", "TM_MAX", "TM_MES", "TM_MIN", "W_MED")]
  
  correlacion_pearson_ <- cor(variables_año, method = "pearson", use = "complete.obs")
  nombre_corp <- paste0("correlacion_pearson_", años[i])
  correlacion_pearson[[nombre_corp]] <- correlacion_pearson_
  
  correlacion_spearman_ <- cor(variables_año, method = "spearman", use = "complete.obs")
  nombre_cors <- paste0("correlacion_spearman_", años[i])
  correlacion_spearman[[nombre_cors]] <- correlacion_spearman_

  covarianzas_ <- cov(variables_año, use = "complete.obs")
  nombres_cov <- paste0("covarianzas_", años[i])
  covarianzas[[nombres_cov]] <- covarianzas_
}

```


```{r}
# Configurar el diseño de la ventana gráfica
par(mfrow = c(3, 3))

for (año in años) {
  corrplot(correlacion_pearson[[paste0("correlacion_pearson_", año)]], 
           method = "color", type = "lower", diag = FALSE)
}

# Restaurar la configuración original de la ventana gráfica
par(mfrow = c(1, 1))

```


Vemos que, en general, estes gráficos que representan la correlación entre las variables son prácticamente iguales para cada año, por lo tanto, vamos a centrarnos en los datos del año $2022$, para realizar un análisis más concreto y preciso.


```{r}
corrplot(correlacion_pearson[["correlacion_pearson_2022"]], type = "lower", diag = FALSE)
```

Por entender un poco mejor lo que nos quiere decir esta gráfica, cuan más grande es el círculo situado en las correspondientes casillas de las variables, más fuerte es la relación entre ellas (en azul si dicha correlación es lineal positiva y en rojo si es negativa). Cuanto más se reduce el tamaño del círculo, esto indica que la correlación entre las variables disminuye.

Por lo tanto, las conclusiones que extraemos de analizar este gráfico son las siguientes:

* La velocidad del viento, *W_MED*, no está prácticamente correlacionada con el resto de variables, por lo que la apartarmos de momento de nuestro estudio.

* Las variables *T_MAX*, *T_MIN* y *T_MES*, que recordamos que hacían referencia a:

  * TM_MAX -> Temperatura media mensual/anual de las máximas (°C)
  * TM_MES -> Temperatura media mensual/anual (°C)
  * TM_MIN -> Temperatura media mensual/anual de las mínimas (°C)
  
  Claramente estas variables están fuertemente correlacionadas, lo cual es lógico y natural, ya que estamos hablando de lo mismo, temperaturas, pero dando un dato distinto cada una de ellas.
  
* Por lo demás, las relaciones más destacables (teniendo en cuenta el objetivo de nuestro estudio) que extraemos del gráfico son las siguientes:

  * insolacion y precipitaciones medias
  * insolacion y humedad
  * temperatura maxima y precipitacion mes
  * temperatura maxima y humedad
  * temperatura maxima e insolacion

Además de centrarnos en el gráfico, echemos un ojo a la matriz de correlaciones, tanto de Pearson como la de Spearman y la matriz de covarianzas.


* Coeficiente de Correlación de Pearson: Mide la fuerza y dirección de una relación lineal.

```{r}
correlacion_pearson[["correlacion_pearson_2022"]]
```

* Coeficiente de Correlación de Spearman: Evalúa la relación monótona entre dos variables.

```{r}
correlacion_spearman[["correlacion_spearman_2022"]]
```

* Matriz de covarianzas.

```{r}
covarianzas[["covarianzas_2022"]]
```

Iniciamos el analisis de la correlacion para el año $2022$:


```{r}
d_22<-dataframes_mensuales[["df_mensual2022"]]
HR<-dataframes_mensuales[["df_mensual2022"]]%>%
  select(Indicativo,Meses,HR)
P_MES<-dataframes_mensuales[["df_mensual2022"]]%>%
  select(Indicativo,Meses,P_MES)
INSO<-dataframes_mensuales[["df_mensual2022"]]%>%
  select(Indicativo,Meses,INSO)
T_MAX<-dataframes_mensuales[["df_mensual2022"]]%>%
  select(Indicativo,Meses,TM_MAX)
T_MES<-dataframes_mensuales[["df_mensual2022"]]%>%
  select(Indicativo,Meses,TM_MES)
```

```{r}
correlation_matrix <- cor(d_22[, c("HR", "P_MES", "INSO", "TM_MAX")])
heatmap(correlation_matrix)

```


  * Insolacion y Precipitaciones medias
  
```{r}
library(ggplot2)
ggplot(d_22, aes(x=INSO, y=P_MES)) +
  geom_point() +
  geom_smooth(method="lm", se=FALSE, color="blue") +
  labs(title="Scatter Plot con Línea de Regresión", x="Insolación", y="Precipitación Media")

```


```{r}
boxplot(d_22$INSO ~ cut(d_22$P_MES, breaks=3), 
        main="Boxplot de Insolación por Niveles de Precipitación", 
        xlab="Niveles de Precipitación", ylab="Insolación")

```


  * Insolacion y Humedad
  
```{r}
ggplot(d_22, aes(x=HR, fill=INSO)) +
  geom_bar(position="stack") +
  labs(title="Gráfico de Barras Apiladas", x="Humedad", y="Frecuencia", fill="Insolación")

```
  
  * Temperatura Maxima y Precipitacion mes
  
```{r}
ggplot(d_22, aes(x=TM_MAX, y=P_MES)) +
  geom_density_2d() +
  labs(title="Gráfico de Contorno o Densidad", x="Temperaturas", y="Precipitación Media")

```

  
  * Temperatura Maxima y Humedad
  
```{r}
ggplot(d_22, aes(x=HR, y=TM_MAX, fill=HR)) +
  geom_violin() +
  labs(title="Diagrama de Violín", x="Humedad", y="Insolación", fill="Humedad")

```

  
  * Temperatura Maxima e Insolacion
  
```{r}
ggplot(d_22, aes(x=TM_MAX, y=INSO, size=INSO)) +
  geom_point(alpha=0.7,col="lightblue",fill="black") +
  labs(title="Gráfico de Burbujas", x="Temperaturas", y="Insolación", size="Temperaturas")
```

  
```{r}
pares<-dataframes_mensuales[["df_mensual2022"]]%>%
  select(HR,INSO,P_MES,TM_MAX,TM_MES,TM_MIN,W_MED)
ggpairs(pares)
#,ggplot2::aes(col="black",fill = "lightblue"
```

```{r}
calcular_correlacion_variable <- function(data, variable, region1, region2, metodo = "pearson") {
  correlacion_resultados <- list()
  
  for (i in seq_along(data)) {
    df_año <- data[[i]]
    df_año$Indicativo <- factor(df_año$Meses, levels = c("enero", "febrero", "marzo", 
                                                         "abril", "mayo", "junio", "julio", "agosto" ,
                                                         "septiembre", "octubre", "noviembre",
                                                         "diciembre"))
    df_año$Meses <- factor(df_año$Meses)
    
    df_region1 <- df_año[df_año$Provincia %in% region1, ]
    df_region2 <- df_año[df_año$Provincia %in% region2, ]
    
    variable_region1 <- df_region1[[variable]]
    variable_region2 <- df_region2[[variable]]
    
    datos_variables <- data.frame(Region1 = variable_region1, Region2 = variable_region2)
    correlacion <- cor(datos_variables, method = metodo, use = "complete.obs")
    
    nombre_correlacion <- paste0("correlacion_", metodo, "_", 
                                 paste(c(region1, region2), collapse = "_"), "_", años[i])
    correlacion_resultados[[nombre_correlacion]] <- correlacion
  }
  
  return(correlacion_resultados)
}

variable_interes <- "P_MES"
region1 <- "ASTURIAS"
region2 <- "PONTEVEDRA"

correlaciones_variables <- calcular_correlacion_variable(dataframes_mensuales, variable_interes, region1, region2, metodo = "pearson")


```

