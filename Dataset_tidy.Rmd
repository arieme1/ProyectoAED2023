---
title: "ProyectoAED"
author: "Alex Riera Merino"
date: "2023-11-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readr)
library(tidyverse)
library(dplyr)
library(mice)
```


```{r}
estaciones<-read_delim("./data/Maestro_Climatologico_2022.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE,show_col_types = FALSE)

agregar_separador <- function(numero, posicion) {
  # Convertir el número a cadena de caracteres
  numero_str <- as.character(numero)
  
  # Insertar el separador en la posición deseada
  numero_formateado <- paste0(
    substr(numero_str, 1, posicion),
    ".",
    substr(numero_str,posicion + 1, nchar(numero_str))
  )
  
  # Devolver el resultado como número
  return(as.numeric(numero_formateado))
}

estaciones$LATITUD <- agregar_separador(estaciones$LATITUD, 2)
estaciones$LONGITUD <- agregar_separador(estaciones$LONGITUD, 1)

estaciones$LONGITUD<-estaciones$LONGITUD*(-1)


estaciones$LONGITUD[estaciones$PROVINCIA %in% c("TARRAGONA", "BARCELONA")] <- -estaciones$LONGITUD[estaciones$PROVINCIA %in% c("TARRAGONA", "BARCELONA")]


```


```{r}
carpeta_base<-"./data/Variables/"

años<-2016:2022

lista_dataframes <- list()

for (año in años){
  
ruta_carpeta<-file.path(carpeta_base, as.character(año))
archivos_climaticos <- list.files(ruta_carpeta,pattern = ".*.csv")


df_año<-data.frame(Indicativo = character(0), Meses = character(0), Valores= numeric(0))


for (archivo in archivos_climaticos) {
  
  ruta_completa_archivo<-file.path(ruta_carpeta,archivo)
  variable <-read_delim(ruta_completa_archivo, delim = ";", escape_double = FALSE,
                          trim_ws=TRUE, show_col_types=FALSE)
  prefijo <- substr(archivo, 1, nchar(archivo) - 9)

  df_variable <- variable %>%
      pivot_longer(col = -c(Indicativo), names_to = "Meses", 
                   values_to = prefijo) 
  
    if (archivo == archivos_climaticos[1]) {
        
      df_año <- df_variable
      
     } else {
       
      df_año <- left_join(df_año,df_variable, by=join_by("Indicativo","Meses"))
     }
  
}
  lista_dataframes[[as.character(año)]] <- df_año
  assign(paste0("df_", año), df_año, envir = .GlobalEnv)
  carpeta<-"./data/"
  nombre_archivo <- file.path(carpeta, paste0("dataset_",año,".csv"))
  write.csv(df_año, nombre_archivo, row.names = FALSE)
}

rm(df_variable,variable,df_año)
```

  * HR -> humedad relativa mensual/anual (%)
  * INSO -> Media mensual/anual de la insolación diaria (horas)
  * P_MES -> Precipitación total mensual/anual (mm)
  * TM_MAX -> Temperatura media mensual/anual de las máximas (°C)
  * TM_MES -> Temperatura media mensual/anual (°C)
  * TM_MIN -> Temperatura media mensual/anual de las mínimas (°C)

```{r}
#ANUAL

Indicativos_maestro <- unique(unlist(estaciones[,"Indicativo"]))
años<-2016:2022
columnas <- c("HR", "INSO","TM_MAX","TM_MES","TM_MIN","W_MED")
columnas2 <- c("P_MES")
dataframes_anuales <- list()
dataframes_mensuales <- list()
i = 2016

for (df in lista_dataframes){
  Indicativos_df <- unique(unlist(df[,"Indicativo"]))
  I_comunes <- intersect(Indicativos_df, Indicativos_maestro)
  
  Localizame <- estaciones[,c("Indicativo","PROVINCIA", "LONGITUD", "LATITUD")]
  Localizame <- Localizame%>%subset(Indicativo %in% I_comunes)

  data_filtered <- df %>% filter(Meses != "anual")%>%subset(Indicativo %in% I_comunes) 

  imputed_data_filtered <- mice(data_filtered, m = 5) 
  imputed_data <- complete(imputed_data_filtered, action = 1) 
#hago la imputación de datos con mice e introduzco los datos

  filtered_rows <- df %>% filter(Meses == "anual")%>%subset(Indicativo %in% I_comunes) 

  result <- imputed_data %>%group_by(Indicativo) %>%summarise(across(all_of(columnas), mean))

  result2 <-imputed_data %>%group_by(Indicativo)%>%summarise(across(all_of("P_MES"), sum))

  df_anual <- mutate(result, result2)
  df_anual<-df_anual[,c("Indicativo","HR","INSO","P_MES","TM_MAX","TM_MES","TM_MIN","W_MED")]
  df_anual <- merge(df_anual, Localizame, by = "Indicativo")
  nombre_df_a <- paste0("df_anual", i)
  dataframes_anuales[[nombre_df_a]] <- df_anual
  carpeta<-"./data/"
  nombre_archivo <- file.path(carpeta, paste0("df_anual", i,".csv"))
  write.csv(df_anual, nombre_archivo, row.names = FALSE)
  
  df_mensual <- merge(imputed_data, Localizame, by = "Indicativo")
  nombre_df_m <-paste0("df_mensual", i)
  dataframes_mensuales[[nombre_df_m]] <- df_mensual

  carpeta<-"./data/"
  nombre_archivo <- file.path(carpeta, paste0("df_mensual", i,".csv"))
  write.csv(df_mensual, nombre_archivo, row.names = FALSE)
  i<-i+1
}

```

